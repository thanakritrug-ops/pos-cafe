<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a2e">
    <title>POS Caf√© Pro ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script>
    tailwind.config = {
        theme: { extend: { colors: {
            gold: { 50:'#fdf8f0', 100:'#f8edd8', 200:'#f0d9ae', 300:'#e5c180', 400:'#d4a556', 500:'#C9A96E', 600:'#b08a4a', 700:'#8d6d38', 800:'#6b5229', 900:'#4a3a1d' },
            navy: { 50:'#f0f1f5', 100:'#d4d6e0', 200:'#a8abbd', 300:'#7c809a', 400:'#505577', 500:'#2d3250', 600:'#1a1a2e', 700:'#141428', 800:'#0f0f20', 900:'#0a0a18' },
        }}}
    }
    </script>
    <style>
        * { font-family: 'Sarabun', sans-serif; }
        body { background: #f5f3ef; }

        /* === LOGIN === */
        .login-bg { min-height:100vh; background:linear-gradient(135deg,#0f0f20 0%,#1a1a2e 40%,#16213e 100%); display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden; }
        .login-bg::before { content:''; position:absolute; inset:0; background:radial-gradient(circle at 20% 80%, rgba(201,169,110,.12) 0%, transparent 60%), radial-gradient(circle at 80% 20%, rgba(201,169,110,.08) 0%, transparent 50%); }
        .login-card { background:rgba(255,255,255,0.97); border-radius:20px; padding:48px 40px; width:420px; box-shadow:0 24px 80px rgba(0,0,0,.4), 0 0 0 1px rgba(255,255,255,.1); position:relative; z-index:1; }
        .login-input { width:100%; padding:14px 16px; border:2px solid #eae7e0; border-radius:10px; font-size:15px; font-family:inherit; transition:all .15s; outline:none; }
        .login-input:focus { border-color:#C9A96E; box-shadow:0 0 0 3px rgba(201,169,110,.12); }
        .login-btn { width:100%; padding:16px; background:linear-gradient(135deg,#C9A96E,#b08a4a); color:white; border:none; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; transition:all .15s; font-family:inherit; }
        .login-btn:hover { background:linear-gradient(135deg,#b08a4a,#8d6d38); transform:translateY(-1px); box-shadow:0 8px 24px rgba(201,169,110,.4); }
        .login-btn:active { transform:translateY(0); }
        .login-hint { background:#f8f6f2; border:1px solid #eae7e0; border-radius:8px; padding:10px 14px; margin-top:16px; }
        .role-badge { display:inline-flex; align-items:center; gap:4px; padding:3px 10px; border-radius:20px; font-size:11px; font-weight:700; }
        .role-owner { background:#fdf0e0; color:#8d6d38; border:1px solid #e5c180; }
        .role-manager { background:#e8f4fd; color:#0078d4; border:1px solid #b3d9f5; }
        .role-staff { background:#dff6dd; color:#107c10; border:1px solid #9fd49b; }

        /* === RECEIPT === */
        @media print {
            body > *:not(#receipt-overlay) { display:none !important; }
            #receipt-overlay { position:static !important; background:none !important; }
            .receipt-card { box-shadow:none !important; }
            .no-print { display:none !important; }
        }
        .receipt-card { background:white; border-radius:16px; width:380px; max-height:90vh; overflow-y:auto; box-shadow:0 24px 80px rgba(0,0,0,.3); }
        .receipt-divider { border:none; border-top:2px dashed #e0ddd8; margin:12px 0; }

        /* === POS === */
        .offline-badge { position:fixed; top:10px; right:10px; background:#ef4444; color:white; padding:5px 15px; border-radius:20px; font-size:12px; z-index:1000; }
        .online-badge { background:#10b981; }
        .product-card { transition:all .2s ease; border:2px solid #eae7e0; cursor:pointer; }
        .product-card:hover { box-shadow:0 8px 25px rgba(0,0,0,.1); transform:translateY(-2px); border-color:#C9A96E; }
        .product-card:active { transform:scale(.97); }
        .add-shot-btn { background:linear-gradient(135deg,#C9A96E,#b08a4a); color:white; font-size:10px; padding:2px 8px; border-radius:4px; cursor:pointer; white-space:nowrap; }
        .add-shot-btn:hover { opacity:.9; }
        .tab-btn { padding:8px 16px; border-radius:8px 8px 0 0; font-size:12px; cursor:pointer; border:1px solid #e0ddd8; border-bottom:none; background:#f8f6f2; white-space:nowrap; color:#666; transition:all .15s; }
        .tab-btn:hover { background:#fff; color:#333; }
        .tab-btn.active { background:white; font-weight:bold; color:#C9A96E; border-color:#C9A96E; }
        .bar-container { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
        .bar-label { width:140px; font-size:12px; text-align:right; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#555; }
        .bar-track { flex:1; height:24px; background:#f0ede8; border-radius:6px; overflow:hidden; }
        .bar-fill { height:100%; border-radius:6px; transition:width .6s ease; display:flex; align-items:center; padding-left:8px; background:linear-gradient(135deg,#C9A96E,#d4a556); }
        .bar-value { font-size:10px; color:white; font-weight:bold; white-space:nowrap; }
        .signal-star { background:#2d7d5f; color:white; }
        .signal-keep { background:#4a6fa5; color:white; }
        .signal-warn { background:#C9A96E; color:white; }
        .signal-drop { background:#c0392b; color:white; }
        .period-btn { padding:6px 14px; border:2px solid #e0ddd8; border-radius:8px; font-size:13px; cursor:pointer; background:white; transition:all .15s; }
        .period-btn:hover { border-color:#C9A96E; background:#fdf8f0; }
        .period-btn.active { border-color:#C9A96E; background:linear-gradient(135deg,#C9A96E,#b08a4a); color:white; font-weight:bold; }
        .date-input { padding:6px 12px; border:2px solid #e0ddd8; border-radius:8px; font-size:13px; background:white; }
        .date-input:focus { outline:none; border-color:#C9A96E; }
        .export-action-btn { padding:10px 20px; border-radius:10px; font-weight:bold; font-size:13px; cursor:pointer; transition:all .15s; display:flex; align-items:center; gap:6px; }
        .export-action-btn:hover { transform:translateY(-1px); box-shadow:0 4px 15px rgba(0,0,0,.12); }
        .btn-gold { background:linear-gradient(135deg,#C9A96E,#b08a4a); color:white; }
        .card { background:white; border-radius:12px; border:1px solid #eae7e0; }
        table thead { background:#f8f6f2; }
        table th { color:#666; font-weight:600; }
        table tr:hover { background:#fdf8f0; }
        .pbi-kpi { background:white; border:1px solid #eae7e0; border-radius:8px; padding:16px; position:relative; overflow:hidden; transition:box-shadow .15s; }
        .pbi-kpi:hover { box-shadow:0 2px 12px rgba(0,0,0,.08); }
        .pbi-kpi::before { content:''; position:absolute; top:0;left:0;right:0; height:3px; }
        .pbi-kpi.c1::before{background:#0078d4;} .pbi-kpi.c2::before{background:#107c10;} .pbi-kpi.c3::before{background:#C9A96E;} .pbi-kpi.c4::before{background:#8764b8;}
        .pbi-card { background:white; border:1px solid #eae7e0; border-radius:8px; padding:16px; }
        .pbi-card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
        .pbi-card-title { font-size:13px; font-weight:700; color:#333; display:flex; align-items:center; gap:6px; }
        .pbi-actions { display:flex; gap:4px; }
        .pbi-abtn { background:none; border:1px solid #eae7e0; border-radius:4px; padding:3px 10px; font-size:10px; cursor:pointer; color:#888; font-family:inherit; transition:all .15s; }
        .pbi-abtn:hover { background:#fdf8f0; }
        .pbi-abtn.active { background:#0078d4; color:#fff; border-color:#0078d4; }
        .pbi-badge { font-size:10px; font-weight:700; padding:2px 8px; border-radius:10px; }
        .pbi-badge.up{background:#dff6dd;color:#107c10;} .pbi-badge.dn{background:#fde7e9;color:#a4262c;} .pbi-badge.neu{background:#f3f2f1;color:#605e5c;}
        .pbi-stab { display:inline-flex; padding:5px 14px; font-size:12px; cursor:pointer; border-radius:6px 6px 0 0; transition:all .15s; color:#888; background:#f5f3ef; border:1px solid transparent; border-bottom:none; }
        .pbi-stab:hover { color:#333; background:#fdf8f0; }
        .pbi-stab.active { background:white; color:#C9A96E; font-weight:700; border-color:#eae7e0; }
        .fbtn-dash { background:#faf9f6; border:1px solid #eae7e0; border-radius:14px; padding:4px 12px; font-size:11px; color:#555; cursor:pointer; transition:all .15s; font-family:inherit; }
        .fbtn-dash:hover { border-color:#0078d4; color:#0078d4; }
        .fbtn-dash.active { background:#0078d4; border-color:#0078d4; color:#fff; font-weight:600; }
        .dl-row { display:flex; align-items:center; gap:7px; padding:4px; border-radius:4px; cursor:pointer; }
        .dl-row:hover { background:#f5f3ef; }
        .dl-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
        /* Image Upload */
        .img-upload-zone { border:2px dashed #C9A96E; border-radius:8px; padding:12px; text-align:center; cursor:pointer; transition:all .15s; }
        .img-upload-zone:hover { background:#fdf8f0; }
        /* Menu sidebar improved */
        .nav-item { padding:10px 14px; border-radius:10px; cursor:pointer; font-size:14px; font-weight:500; transition:all .15s; display:flex; align-items:center; gap:10px; }
        .nav-item:hover { background:rgba(255,255,255,.08); }
        .nav-item.active { background:rgba(201,169,110,.2); color:#C9A96E; }
        .nav-item .nav-icon { font-size:16px; min-width:20px; }
        ::-webkit-scrollbar { width:5px; }
        ::-webkit-scrollbar-thumb { background:#ccc; border-radius:3px; }
        ::-webkit-scrollbar-thumb:hover { background:#aaa; }
    </style>
</head>
<body class="bg-[#f5f3ef]">
<div id="app"></div>
<script>
// ==================== ONLINE STATUS ====================
function updateOnlineStatus() {
    let b=document.getElementById('online-badge');
    if(!b){b=document.createElement('div');b.id='online-badge';document.body.appendChild(b);}
    b.className=navigator.onLine?'offline-badge online-badge':'offline-badge';
    b.textContent=navigator.onLine?'üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå':'üî¥ ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå';
}
window.addEventListener('online',updateOnlineStatus);
window.addEventListener('offline',updateOnlineStatus);
window.addEventListener('load',updateOnlineStatus);

// ==================== AUTH MANAGER ====================
class AuthManager {
    constructor() {
        this._defaultUsers = [
            {id:1, username:'owner', password:'owner1234', role:'owner', name:'‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô'},
            {id:2, username:'manager', password:'mgr1234', role:'manager', name:'‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£'},
            {id:3, username:'staff', password:'staff1234', role:'staff', name:'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢'},
        ];
        this.users = JSON.parse(localStorage.getItem('pos_users')) || this._defaultUsers;
        this.currentUser = JSON.parse(sessionStorage.getItem('pos_user')) || null;
    }
    login(username, password) {
        const user = this.users.find(u=>u.username===username && u.password===password && u.active!==false);
        if(user) { this.currentUser = user; sessionStorage.setItem('pos_user', JSON.stringify(user)); return user; }
        return null;
    }
    logout() { this.currentUser = null; sessionStorage.removeItem('pos_user'); }
    isLoggedIn() { return !!this.currentUser; }
    can(action) {
        if(!this.currentUser) return false;
        const perms = {
            owner:   ['pos','reports','all_reports','settings','demo','clear','manage_users','manage_products','supabase'],
            manager: ['pos','reports','all_reports'],
            staff:   ['pos','own_history'],
        };
        return (perms[this.currentUser.role]||[]).includes(action);
    }
    get role() { return this.currentUser?.role || null; }
    get name() { return this.currentUser?.name || ''; }
    saveUsers() { localStorage.setItem('pos_users', JSON.stringify(this.users)); }
    addUser(u) { u.id = Date.now(); this.users.push(u); this.saveUsers(); }
    updateUser(id, data) { const i=this.users.findIndex(u=>u.id===id); if(i>=0){this.users[i]={...this.users[i],...data};this.saveUsers();} }
    deleteUser(id) { this.users=this.users.filter(u=>u.id!==id); this.saveUsers(); }
}

// ==================== POS APP ====================
class POSApp {
    constructor() {
        this.auth = new AuthManager();
        this.state = {
            selectedCategory:'coffee', cart:[], discount:10, currentView:'pos',
            orders:[], showSettings:false, showSweetness:false, sweetnessProduct:null,
            selectedMonth:'all', reportTab:'dashboard', topCategory:'all', dashSubTab:'overview',
            dashPeriod:'all', dashDate:new Date().toISOString().split('T')[0], dashWeekOffset:0,
            dashMonthKey:`${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`,
            dashYear:String(new Date().getFullYear()), dashCompare:false,
            dashDate2:(()=>{const d=new Date();d.setDate(d.getDate()-1);return d.toISOString().split('T')[0];})(),
            dashWeekOffset2:1,
            dashMonthKey2:(()=>{const d=new Date();d.setMonth(d.getMonth()-1);return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;})(),
            dashYear2:String(new Date().getFullYear()-1), dashTopCat:'all',
            exportPeriod:'day', exportDate:new Date().toISOString().split('T')[0],
            exportWeek:this.getISOWeek(new Date()),
            exportMonth:`${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`,
            exportYear:String(new Date().getFullYear()),
            googleSheetUrl:localStorage.getItem('googleSheetUrl')||'',
            autoExportSheets:localStorage.getItem('autoExportSheets')==='true',
            supabaseUrl:localStorage.getItem('supabaseUrl')||'',
            supabaseKey:localStorage.getItem('supabaseKey')||'',
            showDemoGenerator:false, demoMonths:3, demoOrdersPerDay:'15-30', demoPeakHour:true,
            // New
            showReceipt:false, lastOrder:null, loginError:'',
            showUserMgmt:false, showAddUser:false, editUserId:null,
            showImageMgmt:false, imageProduct:null,
        };

        let id=1;
        this.products = [
            {id:id++,name:'‡πÄ‡∏≠‡∏™‡πÄ‡∏û‡∏£‡πÇ‡∏ã‡πà ‡∏£‡πâ‡∏≠‡∏ô',price:40,cost:15,category:'coffee',image:'‚òï',isDrink:true},
            {id:id++,name:'‡πÄ‡∏≠‡∏™‡πÄ‡∏û‡∏£‡πÇ‡∏ã‡πà ‡πÄ‡∏¢‡πá‡∏ô',price:50,cost:18,category:'coffee',image:'‚òï',isDrink:true},
            {id:id++,name:'‡πÄ‡∏≠‡∏™‡πÄ‡∏û‡∏£‡πÇ‡∏ã‡πà ‡∏õ‡∏±‡πà‡∏ô',price:60,cost:22,category:'coffee',image:'‚òï',isDrink:true},
            {id:id++,name:'‡∏Ñ‡∏≤‡∏õ‡∏π‡∏ä‡∏¥‡πÇ‡∏ô‡πà ‡∏£‡πâ‡∏≠‡∏ô',price:40,cost:15,category:'coffee',image:'‚òï',isDrink:true},
            {id:id++,name:'‡∏Ñ‡∏≤‡∏õ‡∏π‡∏ä‡∏¥‡πÇ‡∏ô‡πà ‡πÄ‡∏¢‡πá‡∏ô',price:50,cost:18,category:'coffee',image:'‚òï',isDrink:true},
            {id:id++,name:'‡∏Ñ‡∏≤‡∏õ‡∏π‡∏ä‡∏¥‡πÇ‡∏ô‡πà ‡∏õ‡∏±‡πà‡∏ô',price:60,cost:22,category:'coffee',image:'‚òï',isDrink:true},
            {id:id++,name:'‡∏°‡∏≠‡∏Ñ‡∏Ñ‡πà‡∏≤ ‡∏£‡πâ‡∏≠‡∏ô',price:40,cost:15,category:'coffee',image:'‚òï',isDrink:true},
            {id:id++,name:'‡∏°‡∏≠‡∏Ñ‡∏Ñ‡πà‡∏≤ ‡πÄ‡∏¢‡πá‡∏ô',price:50,cost:18,category:'coffee',image:'‚òï',isDrink:true},
            {id:id++,name:'‡∏°‡∏≠‡∏Ñ‡∏Ñ‡πà‡∏≤ ‡∏õ‡∏±‡πà‡∏ô',price:60,cost:22,category:'coffee',image:'‚òï',isDrink:true},
            {id:id++,name:'‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà ‡∏£‡πâ‡∏≠‡∏ô',price:40,cost:15,category:'coffee',image:'‚òï',isDrink:true},
            {id:id++,name:'‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà ‡πÄ‡∏¢‡πá‡∏ô',price:50,cost:18,category:'coffee',image:'‚òï',isDrink:true},
            {id:id++,name:'‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà ‡∏õ‡∏±‡πà‡∏ô',price:60,cost:22,category:'coffee',image:'‚òï',isDrink:true},
            {id:id++,name:'‡∏•‡∏≤‡πÄ‡∏ï‡πâ ‡∏£‡πâ‡∏≠‡∏ô',price:40,cost:15,category:'coffee',image:'‚òï',isDrink:true},
            {id:id++,name:'‡∏•‡∏≤‡πÄ‡∏ï‡πâ ‡πÄ‡∏¢‡πá‡∏ô',price:50,cost:18,category:'coffee',image:'‚òï',isDrink:true},
            {id:id++,name:'‡∏•‡∏≤‡πÄ‡∏ï‡πâ ‡∏õ‡∏±‡πà‡∏ô',price:60,cost:22,category:'coffee',image:'‚òï',isDrink:true},
            {id:id++,name:'‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà ‡∏™‡πâ‡∏°',price:60,cost:22,category:'coffee',image:'üçä',isDrink:true},
            {id:id++,name:'‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß',price:60,cost:22,category:'coffee',image:'ü••',isDrink:true},
            {id:id++,name:'‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß ‡∏£‡πâ‡∏≠‡∏ô',price:40,cost:14,category:'tea',image:'üçµ',isDrink:true},
            {id:id++,name:'‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß ‡πÄ‡∏¢‡πá‡∏ô',price:50,cost:18,category:'tea',image:'üçµ',isDrink:true},
            {id:id++,name:'‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß ‡∏õ‡∏±‡πà‡∏ô',price:60,cost:22,category:'tea',image:'üçµ',isDrink:true},
            {id:id++,name:'‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏£‡πâ‡∏≠‡∏ô',price:40,cost:14,category:'tea',image:'üçµ',isDrink:true},
            {id:id++,name:'‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏¢‡πá‡∏ô',price:50,cost:18,category:'tea',image:'üçµ',isDrink:true},
            {id:id++,name:'‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏õ‡∏±‡πà‡∏ô',price:60,cost:22,category:'tea',image:'üçµ',isDrink:true},
            {id:id++,name:'‡∏ä‡πá‡∏≠‡∏Ñ‡πÇ‡∏Å‡πÅ‡∏•‡∏ï ‡∏£‡πâ‡∏≠‡∏ô',price:40,cost:15,category:'tea',image:'üç´',isDrink:true},
            {id:id++,name:'‡∏ä‡πá‡∏≠‡∏Ñ‡πÇ‡∏Å‡πÅ‡∏•‡∏ï ‡πÄ‡∏¢‡πá‡∏ô',price:50,cost:18,category:'tea',image:'üç´',isDrink:true},
            {id:id++,name:'‡∏ä‡πá‡∏≠‡∏Ñ‡πÇ‡∏Å‡πÅ‡∏•‡∏ï ‡∏õ‡∏±‡πà‡∏ô',price:60,cost:22,category:'tea',image:'üç´',isDrink:true},
            {id:id++,name:'‡∏ä‡∏≤‡∏°‡∏∞‡∏ô‡∏≤‡∏ß',price:50,cost:18,category:'tea',image:'üçã',isDrink:true},
            {id:id++,name:'‡∏ä‡∏≤‡∏î‡∏≥',price:50,cost:16,category:'tea',image:'üçµ',isDrink:true},
            {id:id++,name:'‡∏ô‡∏°‡∏™‡∏î ‡∏£‡πâ‡∏≠‡∏ô',price:40,cost:14,category:'tea',image:'ü•õ',isDrink:true},
            {id:id++,name:'‡∏ô‡∏°‡∏™‡∏î ‡πÄ‡∏¢‡πá‡∏ô',price:50,cost:18,category:'tea',image:'ü•õ',isDrink:true},
            {id:id++,name:'‡∏ô‡∏°‡∏™‡∏î ‡∏õ‡∏±‡πà‡∏ô',price:60,cost:22,category:'tea',image:'ü•õ',isDrink:true},
            {id:id++,name:'‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏±‡∏ó‡∏â‡∏∞ ‡∏£‡πâ‡∏≠‡∏ô',price:30,cost:12,category:'tea',image:'üçµ',isDrink:true},
            {id:id++,name:'‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏±‡∏ó‡∏â‡∏∞ ‡πÄ‡∏¢‡πá‡∏ô',price:45,cost:18,category:'tea',image:'üçµ',isDrink:true},
            {id:id++,name:'‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏±‡∏ó‡∏â‡∏∞ ‡∏õ‡∏±‡πà‡∏ô',price:55,cost:22,category:'tea',image:'üçµ',isDrink:true},
            {id:id++,name:'‡∏™‡πâ‡∏°‡∏™‡∏°‡∏π‡∏ó‡∏ï‡∏µ‡πâ',price:50,cost:18,category:'softdrink',image:'üçä',isDrink:true},
            {id:id++,name:'‡πÅ‡∏ï‡∏á‡πÇ‡∏°‡∏™‡∏°‡∏π‡∏ó‡∏ï‡∏µ‡πâ',price:50,cost:18,category:'softdrink',image:'üçâ',isDrink:true},
            {id:id++,name:'‡∏™‡∏ï‡∏£‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡∏£‡∏µ‡πà‡∏™‡∏°‡∏π‡∏ó‡∏ï‡∏µ‡πâ',price:50,cost:18,category:'softdrink',image:'üçì',isDrink:true},
            {id:id++,name:'‡∏Å‡∏µ‡∏ß‡∏µ‡∏™‡∏°‡∏π‡∏ó‡∏ï‡∏µ‡πâ',price:50,cost:18,category:'softdrink',image:'ü•ù',isDrink:true},
            {id:id++,name:'‡πÅ‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏•‡∏π‡∏õ‡∏™‡∏°‡∏π‡∏ó‡∏ï‡∏µ‡πâ',price:50,cost:18,category:'softdrink',image:'üçà',isDrink:true},
            {id:id++,name:'‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏™‡∏°‡∏π‡∏ó‡∏ï‡∏µ‡πâ',price:50,cost:18,category:'softdrink',image:'üçå',isDrink:true},
            {id:id++,name:'‡∏°‡∏¥‡∏Å‡∏ã‡πå‡πÄ‡∏ö‡∏≠‡∏£‡∏£‡∏µ‡πà‡∏™‡∏°‡∏π‡∏ó‡∏ï‡∏µ‡πâ',price:50,cost:18,category:'softdrink',image:'ü´ê',isDrink:true},
            {id:id++,name:'‡∏™‡∏ï‡∏£‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡∏£‡∏µ‡πà‡πÇ‡∏ã‡∏î‡∏≤',price:30,cost:10,category:'softdrink',image:'üçì',isDrink:true},
            {id:id++,name:'‡∏Å‡∏µ‡∏ß‡∏µ‡πÇ‡∏ã‡∏î‡∏≤',price:30,cost:10,category:'softdrink',image:'ü•ù',isDrink:true},
            {id:id++,name:'‡∏™‡πâ‡∏°‡πÇ‡∏ã‡∏î‡∏≤',price:30,cost:10,category:'softdrink',image:'üçä',isDrink:true},
            {id:id++,name:'‡πÄ‡∏™‡∏≤‡∏ß‡∏£‡∏™‡πÇ‡∏ã‡∏î‡∏≤',price:30,cost:10,category:'softdrink',image:'üü°',isDrink:true},
            {id:id++,name:'‡∏ö‡πä‡∏ß‡∏¢‡πÇ‡∏ã‡∏î‡∏≤',price:30,cost:10,category:'softdrink',image:'üü§',isDrink:true},
            {id:id++,name:'‡∏ö‡∏π‡∏•‡∏Æ‡∏≤‡∏ß‡∏≤‡∏¢',price:30,cost:10,category:'softdrink',image:'üîµ',isDrink:true},
            {id:id++,name:'‡πÅ‡∏î‡∏á‡πÇ‡∏ã‡∏î‡∏≤',price:30,cost:10,category:'softdrink',image:'üî¥',isDrink:true},
            {id:id++,name:'‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÇ‡∏ã‡∏î‡∏≤',price:30,cost:10,category:'softdrink',image:'üü¢',isDrink:true},
            {id:id++,name:'‡πÅ‡∏î‡∏á‡∏°‡∏∞‡∏ô‡∏≤‡∏ß‡πÇ‡∏ã‡∏î‡∏≤',price:35,cost:12,category:'softdrink',image:'üî¥',isDrink:true},
            {id:id++,name:'‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏∞‡∏ô‡∏≤‡∏ß‡πÇ‡∏ã‡∏î‡∏≤',price:35,cost:12,category:'softdrink',image:'üü¢',isDrink:true},
            {id:id++,name:'‡∏ö‡∏π‡∏•‡πÄ‡∏ö‡∏≠‡∏£‡∏£‡∏µ‡πà‡∏ä‡∏µ‡∏™‡∏û‡∏≤‡∏¢',price:69,cost:28,category:'bakery',image:'ü´ê',isDrink:false},
            {id:id++,name:'‡∏™‡∏ï‡∏£‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡∏£‡∏µ‡πà‡∏ä‡∏µ‡∏™‡∏û‡∏≤‡∏¢',price:69,cost:28,category:'bakery',image:'üçì',isDrink:false},
            {id:id++,name:'‡πÄ‡∏Ñ‡πâ‡∏Å‡∏™‡πâ‡∏°',price:50,cost:20,category:'bakery',image:'üçä',isDrink:false},
            {id:id++,name:'‡πÄ‡∏Ñ‡πâ‡∏Å‡∏ä‡πá‡∏≠‡∏Ñ‡πÇ‡∏Å‡πÅ‡∏•‡∏ï',price:50,cost:20,category:'bakery',image:'üç´',isDrink:false},
            {id:id++,name:'‡πÅ‡∏ã‡∏ô‡∏ß‡∏¥‡∏ä‡∏ó‡∏∏‡∏ô‡πà‡∏≤',price:30,cost:12,category:'bakery',image:'ü•™',isDrink:false},
            {id:id++,name:'‡πÅ‡∏ã‡∏ô‡∏ß‡∏¥‡∏ä‡πÅ‡∏Æ‡∏°‡∏ä‡∏µ‡∏™',price:30,cost:12,category:'bakery',image:'ü•™',isDrink:false},
            {id:id++,name:'‡πÅ‡∏ã‡∏ô‡∏ß‡∏¥‡∏ä‡∏õ‡∏π‡∏≠‡∏±‡∏î',price:30,cost:12,category:'bakery',image:'ü•™',isDrink:false},
            {id:id++,name:'‡∏ó‡∏≠‡∏ü‡∏ü‡∏µ‡πà‡πÄ‡∏Ñ‡πâ‡∏Å',price:50,cost:20,category:'bakery',image:'üç∞',isDrink:false},
            {id:id++,name:'‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏õ‡∏¥‡πâ‡∏á',price:20,cost:6,category:'bakery',image:'üçû',isDrink:false},
            {id:id++,name:'‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏õ‡∏¥‡πâ‡∏á‡πÄ‡∏ô‡∏¢+‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•',price:20,cost:7,category:'bakery',image:'üçû',isDrink:false},
            {id:id++,name:'‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏õ‡∏¥‡πâ‡∏á‡πÄ‡∏ô‡∏¢+‡∏ô‡∏°',price:20,cost:7,category:'bakery',image:'üçû',isDrink:false},
            {id:id++,name:'‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏õ‡∏¥‡πâ‡∏á‡πÄ‡∏ô‡∏¢+‡∏ô‡∏°+‡∏ï‡∏≤‡∏•',price:20,cost:8,category:'bakery',image:'üçû',isDrink:false},
            {id:id++,name:'‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏õ‡∏¥‡πâ‡∏á‡πÄ‡∏ô‡∏¢+‡∏ä‡πá‡∏≠‡∏Ñ',price:20,cost:8,category:'bakery',image:'üçû',isDrink:false},
            {id:id++,name:'‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏õ‡∏¥‡πâ‡∏á‡πÄ‡∏ô‡∏¢+‡πÅ‡∏¢‡∏°‡∏™‡∏ï‡∏£‡∏≠',price:20,cost:8,category:'bakery',image:'üçû',isDrink:false},
            {id:id++,name:'‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏õ‡∏¥‡πâ‡∏á‡πÄ‡∏ô‡∏¢+‡πÅ‡∏¢‡∏°‡∏™‡πâ‡∏°',price:20,cost:8,category:'bakery',image:'üçû',isDrink:false},
            {id:id++,name:'‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏õ‡∏¥‡πâ‡∏á+‡∏Å‡∏•‡πâ‡∏ß‡∏¢+‡∏ä‡πá‡∏≠‡∏Ñ',price:30,cost:12,category:'bakery',image:'üçû',isDrink:false},
            {id:id++,name:'‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏´‡∏ç‡πà',price:25,cost:10,category:'bakery',image:'üç™',isDrink:false},
            {id:id++,name:'‡πÄ‡∏Ñ‡πâ‡∏Å‡πÄ‡∏£‡∏î‡πÄ‡∏ß‡∏•‡πÄ‡∏ß‡∏ó',price:69,cost:28,category:'bakery',image:'üç∞',isDrink:false},
            {id:id++,name:'‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á',price:95,cost:40,category:'bakery',image:'üç™',isDrink:false},
            {id:id++,name:'‡πÄ‡∏Ñ‡πâ‡∏Å‡∏Å‡∏≤‡πÅ‡∏ü',price:69,cost:28,category:'bakery',image:'üç∞',isDrink:false},
            {id:id++,name:'‡∏™‡∏ï‡∏£‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡∏£‡∏µ‡πà‡∏ä‡πá‡∏≠‡∏ï‡πÄ‡∏Ñ‡πâ‡∏Å',price:69,cost:28,category:'bakery',image:'üç∞',isDrink:false},
            {id:id++,name:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πá‡∏≠‡∏ï',price:10,cost:4,category:'other',image:'‚ûï',isDrink:false,isAddon:true},
            {id:id++,name:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á',price:10,cost:4,category:'other',image:'üßÅ',isDrink:false,isAddon:true},
            {id:id++,name:'‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°',price:7,cost:3,category:'other',image:'üíß',isDrink:false},
            {id:id++,name:'‡∏™‡∏ï‡∏£‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡∏£‡∏µ‡πà‡πÇ‡∏¢‡πÄ‡∏Å‡∏¥‡∏£‡πå‡∏ï',price:60,cost:22,category:'other',image:'üçì',isDrink:true},
            {id:id++,name:'‡∏°‡∏¥‡∏Å‡∏ã‡πå‡πÄ‡∏ö‡∏≠‡∏£‡∏£‡∏µ‡πà‡πÇ‡∏¢‡πÄ‡∏Å‡∏¥‡∏£‡πå‡∏ï',price:60,cost:22,category:'other',image:'ü´ê',isDrink:true},
            {id:id++,name:'‡∏ô‡∏°‡∏™‡∏î‡∏™‡∏ï‡∏£‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡∏£‡∏µ‡πà‡πÇ‡∏¢‡πÄ‡∏Å‡∏¥‡∏£‡πå‡∏ï',price:65,cost:25,category:'other',image:'ü•õ',isDrink:true},
            {id:id++,name:'‡∏Ñ‡∏£‡∏±‡∏ß‡∏ã‡∏≠‡∏á‡πÅ‡∏Æ‡∏°‡∏ä‡∏µ‡∏™',price:50,cost:20,category:'other',image:'ü•ê',isDrink:false},
            {id:id++,name:'‡πÅ‡∏Å‡πâ‡∏ß‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô 30 oz+‡∏ô‡πâ‡∏≥',price:250,cost:90,category:'promotion',image:'üèÜ',isDrink:false},
            {id:id++,name:'‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°',price:35,cost:12,category:'promotion',image:'üßÑ',isDrink:false},
            {id:id++,name:'‡∏ß‡∏≤‡∏ü‡πÄ‡∏ü‡∏¥‡∏•',price:30,cost:10,category:'promotion',image:'üßá',isDrink:false},
            {id:id++,name:'‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ‡∏Ñ‡∏•‡∏∞‡∏£‡∏™ ‡πÄ‡∏•‡πá‡∏Å',price:49,cost:20,category:'promotion',image:'üç™',isDrink:false},
            {id:id++,name:'‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡πâ‡∏ß 20 oz 150‡∏ø',price:150,cost:55,category:'promotion',image:'ü•§',isDrink:false},
            {id:id++,name:'‡∏ô‡πâ‡∏≥‡∏™‡πâ‡∏°‡∏Ñ‡∏±‡πâ‡∏ô',price:50,cost:18,category:'promotion',image:'üçä',isDrink:true},
            {id:id++,name:'‡πÄ‡∏Ñ‡πâ‡∏Å 1 ‡πÅ‡∏ñ‡∏° 1',price:69,cost:35,category:'promotion',image:'üéâ',isDrink:false},
            {id:id++,name:'‡πÅ‡∏Å‡πâ‡∏ß‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô 20 oz+‡∏ô‡πâ‡∏≥',price:230,cost:80,category:'promotion',image:'üèÜ',isDrink:false},
        ];
        this.categories = [
            {id:'coffee',name:'Coffee',icon:'‚òï'},{id:'tea',name:'Tea',icon:'üçµ'},
            {id:'softdrink',name:'Soft Drink',icon:'ü•§'},{id:'bakery',name:'Bakery',icon:'ü•ê'},
            {id:'other',name:'Other',icon:'üì¶'},{id:'promotion',name:'Promotion',icon:'üéâ'}
        ];
        this.sweetnessLevels = [{value:0,label:'0%'},{value:25,label:'25%'},{value:50,label:'50%'},{value:75,label:'75%'},{value:100,label:'100%'}];
        // Load product images from localStorage
        this.productImages = JSON.parse(localStorage.getItem('pos_product_images')) || {};
        this.loadOrders();
    }

    // ==================== IMAGE MANAGEMENT ====================
    getProductImage(productId) { return this.productImages[productId] || null; }
    setProductImage(productId, dataUrl) {
        this.productImages[productId] = dataUrl;
        try { localStorage.setItem('pos_product_images', JSON.stringify(this.productImages)); } catch(e) { alert('‚ö†Ô∏è ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏ï‡πá‡∏° ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ'); }
    }
    removeProductImage(productId) {
        delete this.productImages[productId];
        localStorage.setItem('pos_product_images', JSON.stringify(this.productImages));
    }

    emojiImg(product, size=44) {
        // product can be {id, image} or just a string (emoji/url)
        const pid = typeof product === 'object' ? product.id : null;
        const src = typeof product === 'object' ? product.image : product;
        // Check custom image first
        const custom = pid ? this.getProductImage(pid) : null;
        if(custom) {
            // base64 always works; URL only when online
            if(custom.startsWith('data:') || navigator.onLine) {
                return `<img src="${custom}" width="${size}" height="${size}" style="object-fit:cover;border-radius:8px;" onerror="this.style.display='none';this.nextSibling.style.display='inline-flex'"><span style="display:none;align-items:center;justify-content:center;width:${size}px;height:${size}px;font-size:${Math.round(size*.6)}px">${src}</span>`;
            }
        }
        // URL emoji
        if(typeof src==='string'&&(src.startsWith('http')||src.startsWith('data:'))) {
            if(!navigator.onLine) {
                // offline: show emoji fallback
                const p = this.products.find(p=>p.id===pid);
                return `<span style="display:inline-flex;align-items:center;justify-content:center;width:${size}px;height:${size}px;font-size:${Math.round(size*.6)}px">${p?.image||'üçΩÔ∏è'}</span>`;
            }
            return `<img src="${src}" width="${size}" height="${size}" style="object-fit:cover;border-radius:8px;">`;
        }
        return `<span style="display:inline-flex;align-items:center;justify-content:center;width:${size}px;height:${size}px;font-size:${Math.round(size*.6)}px">${src}</span>`;
    }

    getISOWeek(d) { const date=new Date(d);date.setHours(0,0,0,0);date.setDate(date.getDate()+3-(date.getDay()+6)%7);const w1=new Date(date.getFullYear(),0,4);const n=1+Math.round(((date-w1)/86400000-3+(w1.getDay()+6)%7)/7);return`${date.getFullYear()}-W${String(n).padStart(2,'0')}`; }
    getWeekRange(s){const[y,w]=s.split('-W').map(Number);const j=new Date(y,0,4);const st=new Date(j);st.setDate(j.getDate()-(j.getDay()||7)+1+(w-1)*7);const e=new Date(st);e.setDate(st.getDate()+6);return{start:st,end:e};}
    getWeekLabel(s){const{start:s2,end:e}=this.getWeekRange(s);return`${s2.toLocaleDateString('th-TH',{day:'numeric',month:'short'})} - ${e.toLocaleDateString('th-TH',{day:'numeric',month:'short',year:'numeric'})}`;}

    // ==================== DATA STORAGE ====================
    loadOrders() {
        this._dbReady=false;
        const req=indexedDB.open('POSCafeDB',1);
        req.onupgradeneeded=(e)=>{const db=e.target.result;if(!db.objectStoreNames.contains('orders'))db.createObjectStore('orders',{keyPath:'id'});};
        req.onsuccess=(e)=>{this._db=e.target.result;this._dbReady=true;
            const tx=this._db.transaction('orders','readonly');const s=tx.objectStore('orders');const g=s.getAll();
            g.onsuccess=()=>{if(g.result&&g.result.length>0){this.state.orders=g.result.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));this.render();}
                else{try{const old=localStorage.getItem('pos_orders');if(old){const p=JSON.parse(old);if(p.length>0){this.state.orders=p;this._saveBatch(p);localStorage.removeItem('pos_orders');}}}catch(e){}this.render();}};
        };
        req.onerror=()=>{try{const s=localStorage.getItem('pos_orders');this.state.orders=s?JSON.parse(s):[];}catch(e){this.state.orders=[];}this.render();};
    }
    _slimOrder(o) { return {id:o.id,timestamp:o.timestamp,items:o.items.map(i=>{const s={name:i.name,price:i.price,cost:i.cost,quantity:i.quantity,category:i.category};if(i.originalName)s.originalName=i.originalName;if(i.sweetness!==undefined)s.sweetness=i.sweetness;if(i.extraShots)s.extraShots=i.extraShots;if(i.isDrink)s.isDrink=true;return s;}),subtotal:o.subtotal,totalCost:o.totalCost,discount:o.discount,vat:o.vat,total:o.total,profit:o.profit,staffId:o.staffId,staffName:o.staffName}; }
    saveOrders() {
        if(this._dbReady&&this._db){try{const tx=this._db.transaction('orders','readwrite');tx.objectStore('orders').put(this._slimOrder(this.state.orders[0]));}catch(e){}}
        else{try{localStorage.setItem('pos_orders',JSON.stringify(this.state.orders.map(o=>this._slimOrder(o))));}catch(e){alert('‚ö†Ô∏è ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡πá‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Export ‡∏Å‡πà‡∏≠‡∏ô');}}
    }
    _saveBatch(orders){if(!this._dbReady||!this._db)return;const slim=orders.map(o=>this._slimOrder(o));let idx=0;const save=()=>{if(idx>=slim.length)return;const tx=this._db.transaction('orders','readwrite');const st=tx.objectStore('orders');const end=Math.min(idx+500,slim.length);for(let i=idx;i<end;i++)st.put(slim[i]);idx=end;tx.oncomplete=save;};save();}
    _clearIDB(){if(this._dbReady&&this._db){const tx=this._db.transaction('orders','readwrite');tx.objectStore('orders').clear();}try{localStorage.removeItem('pos_orders');}catch(e){}}

    // ==================== SUPABASE ====================
    async syncToSupabase(order) {
        const url = this.state.supabaseUrl, key = this.state.supabaseKey;
        if(!url||!key||!navigator.onLine) return;
        try {
            await fetch(`${url}/rest/v1/orders`, {
                method:'POST', headers:{'Content-Type':'application/json','apikey':key,'Authorization':`Bearer ${key}`,'Prefer':'return=minimal'},
                body: JSON.stringify({id:order.id,timestamp:order.timestamp,items:order.items,subtotal:order.subtotal,total_cost:order.totalCost,discount:order.discount,vat:order.vat,total:order.total,profit:order.profit,staff_id:order.staffId||'',staff_name:order.staffName||''})
            });
        } catch(e) { console.log('Supabase sync error:', e); }
    }

    // ==================== CART ACTIONS ====================
    addToCart(product) {
        if(product.isDrink){this.state.showSweetness=true;this.state.sweetnessProduct=product;this.render();return;}
        const ex=this.state.cart.find(i=>i.id===product.id&&!i.sweetness&&i.sweetness!==0);
        if(ex)ex.quantity++;else this.state.cart.push({...product,quantity:1});
        this.render();
    }
    addToCartWithSweetness(product,sweetness){
        const dn=`${product.name} (${sweetness}%)`;
        const ex=this.state.cart.find(i=>i.id===product.id&&i.sweetness===sweetness);
        if(ex)ex.quantity++;else this.state.cart.push({...product,name:dn,originalName:product.name,sweetness,quantity:1});
        this.state.showSweetness=false;this.state.sweetnessProduct=null;this.render();
    }
    addShotToCartItem(i){const item=this.state.cart[i];if(!item.extraShots)item.extraShots=0;item.extraShots++;item.price+=10;this.render();}
    updateQuantity(i,c){this.state.cart[i].quantity+=c;if(this.state.cart[i].quantity<=0)this.state.cart.splice(i,1);this.render();}
    removeFromCart(i){this.state.cart.splice(i,1);this.render();}
    clearCart(){this.state.cart=[];this.render();}
    closeReceipt(){this.state.showReceipt=false;this.state.lastOrder=null;this.render();}

    checkout() {
        if(!this.state.cart.length) return;
        const sub=this.state.cart.reduce((s,i)=>s+i.price*i.quantity,0);
        const tc=this.state.cart.reduce((s,i)=>s+i.cost*i.quantity,0);
        const disc=(sub*this.state.discount)/100;
        const vat=(sub-disc)*0.07; const tot=sub-disc+vat; const prof=tot-tc;
        const order={id:Date.now(),timestamp:new Date().toISOString(),items:[...this.state.cart],subtotal:sub,totalCost:tc,discount:disc,vat,total:tot,profit:prof,staffId:this.auth.currentUser?.id,staffName:this.auth.currentUser?.name||''};
        this.state.orders.unshift(order);
        this.saveOrders();
        // Supabase sync
        this.syncToSupabase(order);
        // Auto Google Sheets
        if(this.state.autoExportSheets&&this.state.googleSheetUrl) this.sendOrderToSheets(order);
        // Show receipt
        this.state.lastOrder=order;
        this.state.showReceipt=true;
        this.state.cart=[];
        this.render();
    }
    async sendOrderToSheets(order){if(!this.state.googleSheetUrl)return;try{const d=new Date(order.timestamp);const rows=order.items.map(item=>({date:d.toLocaleDateString('th-TH'),time:d.toLocaleTimeString('th-TH'),category:this.getCategoryName(item.category),item:item.name,quantity:item.quantity,price:item.price,cost:item.cost,subtotal:order.subtotal.toFixed(2),discount:order.discount.toFixed(2),vat:order.vat.toFixed(2),total:order.total.toFixed(2),profit:order.profit.toFixed(2),staff:order.staffName||''}));await fetch(this.state.googleSheetUrl,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:rows,month:`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`})});}catch(e){}}

    getCategoryName(c){return{coffee:'Coffee',tea:'Tea',softdrink:'Soft Drink',bakery:'Bakery',other:'Other',promotion:'Promotion'}[c]||c;}
    getFilteredProducts(){return this.products.filter(p=>p.category===this.state.selectedCategory);}
    getAvailableMonths(){const m=new Set();this.state.orders.forEach(o=>{const d=new Date(o.timestamp);m.add(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);});return Array.from(m).sort().reverse();}
    getMonthName(mk){if(mk==='all')return'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';const[y,m]=mk.split('-');const n=['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];return`${n[parseInt(m)-1]} ${parseInt(y)+543}`;}
    getMonthNameFull(mk){if(mk==='all')return'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';const[y,m]=mk.split('-');const n=['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];return`${n[parseInt(m)-1]} ${parseInt(y)+543}`;}
    getFilteredOrders(){if(this.state.selectedMonth==='all')return this.state.orders;return this.state.orders.filter(o=>{const d=new Date(o.timestamp);return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`===this.state.selectedMonth;});}

    getExportOrders(){const p=this.state.exportPeriod;return this.state.orders.filter(o=>{const d=new Date(o.timestamp);if(p==='day')return d.toISOString().split('T')[0]===this.state.exportDate;if(p==='week'){const{start,end}=this.getWeekRange(this.state.exportWeek);start.setHours(0,0,0,0);end.setHours(23,59,59,999);return d>=start&&d<=end;}if(p==='month')return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`===this.state.exportMonth;if(p==='year')return String(d.getFullYear())===this.state.exportYear;return true;});}
    getExportLabel(){const p=this.state.exportPeriod;if(p==='day'){const d=new Date(this.state.exportDate+'T00:00:00');return`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d.toLocaleDateString('th-TH',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}`;}if(p==='week')return`‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ${this.getWeekLabel(this.state.exportWeek)}`;if(p==='month')return this.getMonthNameFull(this.state.exportMonth);if(p==='year')return`‡∏õ‡∏µ ${parseInt(this.state.exportYear)+543}`;return'';}
    calcExportStats(orders){const revenue=orders.reduce((s,o)=>s+o.total,0),cost=orders.reduce((s,o)=>s+o.totalCost,0),profit=orders.reduce((s,o)=>s+o.profit,0),items=orders.reduce((s,o)=>s+o.items.reduce((ss,i)=>ss+i.quantity,0),0),margin=revenue>0?(profit/revenue*100):0;const productMap={},catMap={};orders.forEach(o=>o.items.forEach(item=>{const k=item.originalName||item.name;if(!productMap[k])productMap[k]={name:k,category:item.category,qty:0,revenue:0,profit:0};productMap[k].qty+=item.quantity;productMap[k].revenue+=item.price*item.quantity;productMap[k].profit+=(item.price-item.cost)*item.quantity;if(!catMap[item.category])catMap[item.category]={qty:0,revenue:0,profit:0};catMap[item.category].qty+=item.quantity;catMap[item.category].revenue+=item.price*item.quantity;catMap[item.category].profit+=(item.price-item.cost)*item.quantity;}));const topProducts=Object.values(productMap).sort((a,b)=>b.qty-a.qty).slice(0,10);return{revenue,cost,profit,items,margin,orderCount:orders.length,topProducts,catMap};}
    exportPeriodCSV(){const orders=this.getExportOrders();if(!orders.length){alert('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');return;}const label=this.getExportLabel();const headers=['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡πÄ‡∏ß‡∏•‡∏≤','‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà','‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡∏£‡∏≤‡∏Ñ‡∏≤','‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô','‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°','‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î','VAT','‡∏™‡∏∏‡∏ó‡∏ò‡∏¥','‡∏Å‡∏≥‡πÑ‡∏£','‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'];const rows=orders.flatMap(o=>{const d=new Date(o.timestamp);return o.items.map(item=>[d.toLocaleDateString('th-TH'),d.toLocaleTimeString('th-TH'),this.getCategoryName(item.category),item.name,item.quantity,item.price,item.cost,o.subtotal.toFixed(2),o.discount.toFixed(2),o.vat.toFixed(2),o.total.toFixed(2),o.profit.toFixed(2),o.staffName||'']);});const csv=[headers.join(','),...rows.map(r=>r.join(','))].join('\n');const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'});const link=document.createElement('a');link.href=URL.createObjectURL(blob);link.download=`POS_${this.state.exportPeriod}_${this.state.exportDate||this.state.exportWeek||this.state.exportMonth||this.state.exportYear}.csv`;link.click();alert(`‚úÖ Export CSV ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n${label}\n${orders.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);}
    async exportPeriodSheets(){const orders=this.getExportOrders();if(!orders.length){alert('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');return;}if(!this.state.googleSheetUrl){this.state.showSettings=true;this.render();return;}try{const data=orders.flatMap(o=>{const d=new Date(o.timestamp);return o.items.map(item=>({date:d.toLocaleDateString('th-TH'),time:d.toLocaleTimeString('th-TH'),category:this.getCategoryName(item.category),item:item.name,quantity:item.quantity,price:item.price,cost:item.cost,subtotal:o.subtotal.toFixed(2),discount:o.discount.toFixed(2),vat:o.vat.toFixed(2),total:o.total.toFixed(2),profit:o.profit.toFixed(2),staff:o.staffName||''}));});const mk=this.state.exportPeriod==='year'?this.state.exportYear:this.state.exportPeriod==='month'?this.state.exportMonth:this.state.exportPeriod==='week'?this.state.exportWeek:this.state.exportDate;await fetch(this.state.googleSheetUrl,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({data,month:mk})});alert(`‚úÖ ‡∏™‡πà‡∏á‡πÑ‡∏õ Google Drive ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\nüìã Tab: ${mk}`);}catch(e){alert('‚ùå '+e.message);}}
    getProductAnalytics(){const fo=this.getFilteredOrders();const m={};fo.forEach(o=>o.items.forEach(item=>{const k=item.originalName||item.name;if(!m[k])m[k]={name:k,category:item.category,quantity:0,revenue:0,cost:0,profit:0,basePrice:item.price,baseCost:item.cost,orders:new Set()};m[k].quantity+=item.quantity;m[k].revenue+=item.price*item.quantity;m[k].cost+=item.cost*item.quantity;m[k].profit+=(item.price-item.cost)*item.quantity;m[k].orders.add(o.id);}));return Object.values(m).map(p=>({...p,profitPerUnit:p.quantity>0?p.profit/p.quantity:0,profitMargin:p.revenue>0?(p.profit/p.revenue)*100:0,orderCount:p.orders.size}));}
    classifyProduct(p,mxQ,mxP){const qr=mxQ>0?p.quantity/mxQ:0,pr=mxP>0?p.profitPerUnit/mxP:0;if(qr>=.3&&pr>=.3)return{label:'‚≠ê Star',cls:'signal-star'};if(qr>=.3)return{label:'üîÑ Volume',cls:'signal-keep'};if(pr>=.3)return{label:'üíé Niche',cls:'signal-warn'};return{label:'‚ö†Ô∏è Review',cls:'signal-drop'};}
    getBundleSuggestions(){const a=this.getProductAnalytics();if(!a.length)return[];const mxQ=Math.max(...a.map(x=>x.quantity));const stars=a.filter(p=>p.quantity/mxQ>=.3).sort((a,b)=>b.quantity-a.quantity).slice(0,5);const slow=a.filter(p=>p.quantity/mxQ<.3&&p.profitPerUnit>0).sort((a,b)=>b.profitPerUnit-a.profitPerUnit).slice(0,5);const bundles=[];stars.forEach(s=>slow.forEach(sl=>{if(s.category!==sl.category){const bp=Math.round((s.basePrice+sl.basePrice)*.9);bundles.push({star:s.name,slow:sl.name,originalTotal:s.basePrice+sl.basePrice,bundlePrice:bp,bundleCost:s.baseCost+sl.baseCost,bundleProfit:bp-(s.baseCost+sl.baseCost),discount:s.basePrice+sl.basePrice-bp,profitMargin:bp>0?((bp-(s.baseCost+sl.baseCost))/bp*100):0});}}));return bundles.sort((a,b)=>b.bundleProfit-a.bundleProfit).slice(0,8);}
    getStockInsights(){const fo=this.getFilteredOrders();if(!fo.length)return{daily:[],daysCount:0,peakHours:[]};const dm={},hm={};fo.forEach(o=>{const d=new Date(o.timestamp);const dk=d.toLocaleDateString('th-TH');const h=d.getHours();if(!hm[h])hm[h]=0;hm[h]++;o.items.forEach(item=>{const k=item.originalName||item.name;if(!dm[k])dm[k]={name:k,category:item.category,totalQty:0,days:new Set()};dm[k].totalQty+=item.quantity;dm[k].days.add(dk);});});return{daily:Object.values(dm).map(d=>({...d,daysActive:d.days.size,avgPerDay:d.days.size>0?d.totalQty/d.days.size:0,suggestedStock:d.days.size>0?Math.ceil(d.totalQty/d.days.size*1.3):0})).sort((a,b)=>b.avgPerDay-a.avgPerDay),daysCount:new Set(fo.map(o=>new Date(o.timestamp).toLocaleDateString('th-TH'))).size,peakHours:Object.entries(hm).map(([h,c])=>({hour:parseInt(h),count:c})).sort((a,b)=>b.count-a.count)};}
    calculateStats(){const fo=this.getFilteredOrders();const ts=fo.reduce((s,o)=>s+o.total,0),tc=fo.reduce((s,o)=>s+o.totalCost,0),tp=fo.reduce((s,o)=>s+o.profit,0),pm=ts>0?(tp/ts)*100:0;const cs={};this.categories.forEach(c=>{cs[c.id]={name:c.name,quantity:0,revenue:0,cost:0,profit:0,icon:c.icon};});fo.forEach(o=>o.items.forEach(i=>{if(cs[i.category]){cs[i.category].quantity+=i.quantity;cs[i.category].revenue+=i.price*i.quantity;cs[i.category].cost+=i.cost*i.quantity;cs[i.category].profit+=(i.price-i.cost)*i.quantity;}}));return{totalSales:ts,totalCost:tc,totalProfit:tp,profitMargin:pm,totalOrders:fo.length,topProducts:this.getProductAnalytics().sort((a,b)=>b.quantity-a.quantity),categorySales:cs};}
    getMonthlyTrend(){const mm={};this.state.orders.forEach(o=>{const d=new Date(o.timestamp);const mk=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;if(!mm[mk])mm[mk]={revenue:0,cost:0,profit:0,orders:0,items:0};mm[mk].revenue+=o.total;mm[mk].cost+=o.totalCost;mm[mk].profit+=o.profit;mm[mk].orders++;mm[mk].items+=o.items.reduce((s,i)=>s+i.quantity,0);});return Object.entries(mm).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>({month:k,monthName:this.getMonthNameFull(k),...v}));}

    // ==================== RENDER MAIN ====================
    render() {
        const app=document.getElementById('app');
        // Show login if not authenticated
        if(!this.auth.isLoggedIn()){app.innerHTML=this.renderLoginScreen();this.bindLoginEvents();return;}

        const sub=this.state.cart.reduce((s,i)=>s+i.price*i.quantity,0);
        const tc=this.state.cart.reduce((s,i)=>s+i.cost*i.quantity,0);
        const disc=(sub*this.state.discount)/100;
        const vat=(sub-disc)*.07; const tot=sub-disc+vat;

        let content='';
        if(this.state.currentView==='pos') content=`<div class="flex h-screen">${this.renderSidebar()}<div class="flex-1 flex overflow-hidden">${this.renderProducts()}${this.renderCart(sub,tc,disc,vat,tot)}</div></div>`;
        else content=`<div class="flex h-screen">${this.renderSidebar()}${this.renderReports()}</div>`;

        if(this.state.showSweetness) content+=this.renderSweetnessModal();
        if(this.state.showSettings) content+=this.renderSettingsModal();
        if(this.state.showDemoGenerator) content+=this.renderDemoModal();
        if(this.state.showReceipt&&this.state.lastOrder) content+=this.renderReceiptModal(this.state.lastOrder);
        if(this.state.showUserMgmt) content+=this.renderUserMgmtModal();
        if(this.state.showImageMgmt&&this.state.imageProduct) content+=this.renderImageMgmtModal();

        app.innerHTML=content;
        this.bindEvents();
        requestAnimationFrame(()=>this.initDashboardCharts());
    }

    // ==================== LOGIN SCREEN ====================
    renderLoginScreen() {
        return `<div class="login-bg">
            <div class="login-card">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 mx-auto mb-4 rounded-2xl overflow-hidden shadow-lg" style="background:linear-gradient(135deg,#C9A96E,#8d6d38)">
                        <div class="w-full h-full flex items-center justify-center text-4xl">‚òï</div>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">POS Caf√© Pro</h1>
                    <p class="text-gray-500 text-sm mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü</p>
                </div>

                ${this.state.loginError?`<div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm text-center">‚ùå ${this.state.loginError}</div>`:''}

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1.5">üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                        <input id="login-username" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" class="login-input" autocomplete="username">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1.5">üîí ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                        <input id="login-password" type="password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="login-input" autocomplete="current-password">
                    </div>
                    <button id="login-btn" class="login-btn mt-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‚Üí</button>
                </div>

                <div class="login-hint mt-5">
                    <div class="text-xs font-bold text-gray-500 mb-2">üîë ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö):</div>
                    <div class="space-y-1.5">
                        <div class="flex items-center gap-2 text-xs"><span class="role-badge role-owner">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</span><code class="bg-gray-100 px-1.5 py-0.5 rounded">owner</code><span class="text-gray-400">/</span><code class="bg-gray-100 px-1.5 py-0.5 rounded">owner1234</code></div>
                        <div class="flex items-center gap-2 text-xs"><span class="role-badge role-manager">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</span><code class="bg-gray-100 px-1.5 py-0.5 rounded">manager</code><span class="text-gray-400">/</span><code class="bg-gray-100 px-1.5 py-0.5 rounded">mgr1234</code></div>
                        <div class="flex items-center gap-2 text-xs"><span class="role-badge role-staff">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span><code class="bg-gray-100 px-1.5 py-0.5 rounded">staff</code><span class="text-gray-400">/</span><code class="bg-gray-100 px-1.5 py-0.5 rounded">staff1234</code></div>
                    </div>
                </div>
            </div>
        </div>`;
    }

    // ==================== SIDEBAR ====================
    renderSidebar() {
        const v=this.state.currentView;
        const u=this.auth.currentUser;
        const roleClass={owner:'role-owner',manager:'role-manager',staff:'role-staff'}[u?.role]||'';
        const roleName={owner:'‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á',manager:'‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£',staff:'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'}[u?.role]||'';
        return `<div class="flex flex-col h-screen" style="width:220px;background:linear-gradient(180deg,#0f0f20 0%,#1a1a2e 60%,#16213e 100%);color:white;flex-shrink:0">
            
            <div class="p-5 pb-4">
                <div class="flex items-center gap-3 mb-5">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center text-2xl" style="background:linear-gradient(135deg,#C9A96E,#8d6d38)">‚òï</div>
                    <div><div class="font-bold text-sm" style="color:#C9A96E">POS Caf√© Pro</div><div class="text-xs" style="color:#888">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</div></div>
                </div>
                
                <div class="p-3 rounded-xl" style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08)">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center text-lg" style="background:rgba(201,169,110,.2)">üë§</div>
                        <div class="flex-1 min-w-0"><div class="text-sm font-medium truncate">${u?.name||''}</div><span class="text-xs px-2 py-0.5 rounded-full ${roleClass}">${roleName}</span></div>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 px-3 space-y-1 overflow-y-auto">
                <div data-view="pos" class="nav-item ${v==='pos'?'active':''}"><span class="nav-icon">üõí</span>‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</div>
                ${this.auth.can('reports')?`<div data-view="reports" class="nav-item ${v==='reports'?'active':''}"><span class="nav-icon">üìä</span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô & ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>`:''}
                <div class="mt-4 mb-1 px-2 text-xs" style="color:rgba(255,255,255,.3);font-weight:600;letter-spacing:.05em">TOOLS</div>
                ${this.auth.can('settings')?`<div class="settings-btn nav-item"><span class="nav-icon">üìä</span>Google Drive ${this.state.autoExportSheets&&this.state.googleSheetUrl?'<span style="color:#C9A96E;margin-left:auto">‚óè</span>':''}</div>`:''}
                ${this.auth.can('supabase')?`<div class="supabase-btn nav-item"><span class="nav-icon">‚òÅÔ∏è</span>Supabase Cloud ${this.state.supabaseUrl?'<span style="color:#10b981;margin-left:auto">‚óè</span>':''}</div>`:''}
                ${this.auth.can('manage_users')?`<div class="user-mgmt-btn nav-item"><span class="nav-icon">üë•</span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>`:''}
                ${this.auth.can('demo')?`<div class="demo-btn nav-item"><span class="nav-icon">üß™</span>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á</div>`:''}
                ${this.auth.can('clear')?`<div class="clear-all-btn nav-item" style="color:rgba(255,100,100,.7)"><span class="nav-icon">üóëÔ∏è</span>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>`:''}
            </nav>
            
            <div class="p-3 pt-0">
                <button class="logout-btn w-full py-2.5 rounded-xl text-sm font-medium transition" style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:#aaa">‚Ü©Ô∏è ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>`;
    }

    // ==================== PRODUCTS ====================
    renderProducts() {
        const prods=this.getFilteredProducts();
        const isAdmin=this.auth.can('manage_products');
        return `<div class="flex-1 flex flex-col overflow-hidden" style="background:#f5f3ef">
            
            <div class="p-3 pb-0">
                <div class="flex gap-2 bg-white p-2.5 rounded-xl shadow-sm border border-gray-100 flex-wrap">
                    ${this.categories.map(c=>`<button data-category="${c.id}" class="category-btn px-3 py-1.5 rounded-lg flex items-center gap-1.5 text-sm font-medium transition ${this.state.selectedCategory===c.id?'text-white shadow-md':'bg-gray-50 hover:bg-gold-50 text-gray-600'}" style="${this.state.selectedCategory===c.id?'background:linear-gradient(135deg,#C9A96E,#b08a4a)':''}"><span>${c.icon}</span><span>${c.name}</span></button>`).join('')}
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-3">
                <div class="grid gap-2" style="grid-template-columns:repeat(auto-fill,minmax(110px,1fr))">
                    ${prods.map(p=>{
                        const customImg=this.getProductImage(p.id);
                        const imgDisplay=customImg?`<img src="${customImg}" style="width:44px;height:44px;object-fit:cover;border-radius:8px" onerror="this.style.display='none'">`:`<span style="font-size:26px">${p.image}</span>`;
                        return `<div data-product-id="${p.id}" class="product-card bg-white rounded-xl p-2.5 cursor-pointer relative group" style="min-height:90px">
                            <div class="flex items-center justify-center mb-1" style="height:44px">${imgDisplay}</div>
                            <div class="text-xs font-medium text-center leading-tight text-gray-700 mb-0.5">${p.name}</div>
                            <div class="text-sm font-bold text-center" style="color:#C9A96E">‡∏ø${p.price}</div>
                            ${isAdmin?`<button data-img-product="${p.id}" class="img-upload-btn absolute top-1 right-1 w-6 h-6 bg-white rounded-full shadow text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition border border-gray-200">üì∑</button>`:''}
                        </div>`;
                    }).join('')}
                </div>
            </div>
        </div>`;
    }

    // ==================== CART ====================
    renderCart(sub,tc,disc,vat,tot) {
        const hasItems = this.state.cart.length > 0;
        const clearBtn = hasItems ? '<button class="clear-cart text-gray-400 hover:text-red-500 text-xl transition">&#x2715;</button>' : '';
        const staffBadge = this.auth.currentUser ? '<div class="text-xs text-gray-400 mt-1">&#x1F464; ' + this.auth.currentUser.name + '</div>' : '';
        let itemsHtml = '';
        if (!hasItems) {
            itemsHtml = '<div class="text-center text-gray-400 mt-16"><div class="text-5xl mb-3">&#x1F6D2;</div><p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p><p class="text-xs mt-1 text-gray-300">‡πÅ‡∏ï‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°</p></div>';
        } else {
            itemsHtml = '<div class="space-y-2">' + this.state.cart.map((item,i) => {
                const shotBtn = item.isDrink ? '<button data-addshot="'+i+'" class="add-shot-btn ml-1">+‡∏ä‡πá‡∏≠‡∏ï</button>' : '';
                const shotInfo = item.extraShots ? ' (+‡∏ä‡πá‡∏≠‡∏ï &#x0e3f;'+(item.extraShots*10)+')' : '';
                return '<div class="bg-gray-50 p-3 rounded-xl">'
                    +'<div class="flex items-start justify-between mb-2">'
                    +'<div class="flex-1 pr-2"><div class="font-medium text-sm leading-tight">'+item.name+'</div>'
                    +'<div class="text-xs text-gray-500 mt-0.5">&#x0e3f;'+item.price+shotInfo+'</div></div>'
                    +'<button data-remove="'+i+'" class="remove-item text-red-400 hover:text-red-600 text-sm">&#x2715;</button></div>'
                    +'<div class="flex items-center justify-between">'
                    +'<div class="flex items-center gap-1">'
                    +'<button data-dec="'+i+'" class="qty-btn w-7 h-7 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-bold">&#x2212;</button>'
                    +'<span class="w-7 text-center font-bold text-sm">'+item.quantity+'</span>'
                    +'<button data-inc="'+i+'" class="qty-btn w-7 h-7 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-bold">+</button>'
                    +shotBtn+'</div>'
                    +'<div class="font-bold text-sm" style="color:#107c10">&#x0e3f;'+(item.price*item.quantity).toFixed(0)+'</div>'
                    +'</div></div>';
            }).join('') + '</div>';
        }
        let bottomHtml = '';
        if (hasItems) {
            bottomHtml = '<div class="p-4 border-t border-gray-100">'
                +'<div class="space-y-1.5 text-sm mb-3">'
                +'<div class="flex justify-between text-gray-600"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span>&#x0e3f;'+sub.toFixed(2)+'</span></div>'
                +'<div class="flex justify-between text-red-500"><span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ('+this.state.discount+'%)</span><span>-&#x0e3f;'+disc.toFixed(2)+'</span></div>'
                +'<div class="flex justify-between text-gray-600"><span>VAT (7%)</span><span>&#x0e3f;'+vat.toFixed(2)+'</span></div>'
                +'<div class="flex justify-between text-lg font-bold pt-2 border-t border-gray-100 mt-2"><span>‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span style="color:#107c10">&#x0e3f;'+tot.toFixed(2)+'</span></div>'
                +'</div>'
                +'<button class="checkout-btn w-full py-3.5 text-white rounded-xl font-bold text-lg shadow-md transition" style="background:linear-gradient(135deg,#C9A96E,#b08a4a)">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô &#x0e3f;'+tot.toFixed(2)+'</button>'
                +'</div>';
        } else {
            bottomHtml = '<div class="p-4 border-t border-gray-100"><button class="checkout-btn w-full py-3.5 rounded-xl font-bold text-lg bg-gray-100 text-gray-400 cursor-not-allowed">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button></div>';
        }
        return '<div class="flex flex-col border-l border-gray-100 bg-white" style="width:360px;flex-shrink:0">'
            +'<div class="p-4 border-b border-gray-100"><div class="flex items-center justify-between">'
            +'<h2 class="text-lg font-bold text-gray-800">&#x1F6D2; ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>'+clearBtn+'</div>'+staffBadge+'</div>'
            +'<div class="flex-1 overflow-y-auto p-3">'+itemsHtml+'</div>'
            +bottomHtml+'</div>';
    }

    // ==================== RECEIPT MODAL ====================
    renderReceiptModal(order) {
        const d=new Date(order.timestamp);
        const shopName='POS Caf√© Pro';
        return `<div class="fixed inset-0 flex items-center justify-center z-50" id="receipt-overlay" style="background:rgba(0,0,0,.6)">
            <div class="receipt-card" id="receipt-content">
                
                <div class="text-center p-6 pb-4" style="background:linear-gradient(135deg,#1a1a2e,#2d3250);color:white;border-radius:16px 16px 0 0">
                    <div class="text-3xl mb-2">‚òï</div>
                    <div class="text-xl font-bold">${shopName}</div>
                    <div class="text-xs mt-1" style="color:rgba(255,255,255,.6)">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
                </div>
                
                <div class="px-5 py-3 bg-gray-50 border-b border-gray-100">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>üìÖ ${d.toLocaleDateString('th-TH',{weekday:'short',year:'numeric',month:'short',day:'numeric'})}</span>
                        <span>‚è∞ ${d.toLocaleTimeString('th-TH')}</span>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>üßæ #${String(order.id).slice(-8)}</span>
                        <span>üë§ ${order.staffName||'‚Äî'}</span>
                    </div>
                </div>
                
                <div class="px-5 py-4">
                    <div class="text-xs font-bold text-gray-400 uppercase mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                    <div class="space-y-2">
                        ${order.items.map(i=>`<div class="flex justify-between items-start">
                            <div class="flex-1 pr-2"><div class="text-sm font-medium">${i.name}</div><div class="text-xs text-gray-400">‡∏ø${i.price} √ó ${i.quantity}</div></div>
                            <div class="text-sm font-bold">‡∏ø${(i.price*i.quantity).toFixed(0)}</div>
                        </div>`).join('')}
                    </div>
                    <hr class="receipt-divider">
                    <div class="space-y-1.5 text-sm">
                        <div class="flex justify-between text-gray-500"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span>‡∏ø${order.subtotal.toFixed(2)}</span></div>
                        <div class="flex justify-between text-red-500"><span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span><span>-‡∏ø${order.discount.toFixed(2)}</span></div>
                        <div class="flex justify-between text-gray-500"><span>VAT 7%</span><span>‡∏ø${order.vat.toFixed(2)}</span></div>
                        <div class="flex justify-between text-lg font-bold pt-2 border-t-2 border-gray-800"><span>‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span style="color:#107c10">‡∏ø${order.total.toFixed(2)}</span></div>
                    </div>
                    <div class="text-center mt-4 pt-3 border-t border-dashed border-gray-200">
                        <div class="text-xs text-gray-400">üôè ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô</div>
                        <div class="text-xs text-gray-300 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≤‡∏≠‡∏µ‡∏Å!</div>
                    </div>
                </div>
                
                <div class="p-4 pt-0 flex gap-2 no-print">
                    <button onclick="window.print()" class="flex-1 py-3 text-white font-bold rounded-xl text-sm" style="background:linear-gradient(135deg,#C9A96E,#b08a4a)">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
                    <button class="close-receipt-btn flex-1 py-3 font-bold rounded-xl text-sm border-2 border-gray-200 text-gray-600 hover:bg-gray-50">‚úï ‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>`;
    }

    // ==================== SWEETNESS MODAL ====================
    renderSweetnessModal() {
        const p=this.state.sweetnessProduct; if(!p)return'';
        return `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl">
                <div class="text-center mb-5">
                    <div class="flex items-center justify-center mb-2 text-4xl">${p.image}</div>
                    <div class="text-lg font-bold">${p.name}</div>
                    <div class="text-gray-500">‡∏ø${p.price}</div>
                </div>
                <div class="mb-5"><div class="font-semibold mb-3 text-sm text-gray-700">üçØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô</div>
                <div class="grid grid-cols-5 gap-2">${this.sweetnessLevels.map(s=>`<button data-sweet-select="${s.value}" class="p-3 border-2 border-gray-200 rounded-xl hover:border-gold-500 hover:bg-gold-50 transition text-center"><div class="text-sm font-bold">${s.label}</div></button>`).join('')}</div></div>
                <button class="cancel-sweetness w-full py-3 border-2 border-gray-200 rounded-xl text-sm font-medium hover:bg-gray-50">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>`;
    }

    // ==================== SETTINGS MODAL ====================
    renderSettingsModal() {
        const hasUrl=!!this.state.googleSheetUrl, autoOn=this.state.autoExportSheets;
        const hasSupa=!!this.state.supabaseUrl;
        const activeTab=this.state.settingsTab||'sheets';
        return `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl max-w-2xl w-full mx-4" style="max-height:90vh;overflow-y:auto">
                <div class="flex items-center justify-between p-5 border-b border-gray-100">
                    <h2 class="text-lg font-bold">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h2>
                    <button class="close-settings text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                </div>
                
                <div class="flex border-b border-gray-100 px-5">
                    <button data-settings-tab="sheets" class="py-3 px-4 text-sm font-medium border-b-2 ${activeTab==='sheets'?'border-gold-500 text-gold-600':'border-transparent text-gray-500'}">üìä Google Sheets</button>
                    <button data-settings-tab="supabase" class="py-3 px-4 text-sm font-medium border-b-2 ${activeTab==='supabase'?'border-gold-500 text-gold-600':'border-transparent text-gray-500'}">‚òÅÔ∏è Supabase</button>
                </div>
                <div class="p-5">
                ${activeTab==='sheets'?`
                    <div class="mb-4 p-3 rounded-lg ${hasUrl?'bg-green-50 border border-green-200':'bg-gray-50 border border-gray-200'}">
                        <span class="text-sm">${hasUrl?'üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡πÅ‡∏•‡πâ‡∏ß':'‚ö™ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'}</span>
                    </div>
                    <div class="mb-4 p-4 bg-gold-50 border border-gold-200 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div><div class="font-bold text-sm">‚ö° ‡∏™‡πà‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div><div class="text-xs text-gray-600 mt-0.5">‡∏ó‡∏∏‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡πà‡∏á‡πÑ‡∏õ Sheets ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div></div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="auto-export-toggle" ${autoOn?'checked':''} ${!hasUrl?'disabled':''} class="sr-only peer"><div class="w-11 h-6 bg-gray-300 peer-checked:bg-gold-500 rounded-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div></label>
                        </div>
                    </div>
                    <div class="mb-5"><label class="block text-sm font-bold mb-2">üîó Google Apps Script URL</label>
                    <input type="text" id="google-sheet-url" value="${this.state.googleSheetUrl}" placeholder="https://script.google.com/macros/s/xxxxx/exec" class="w-full px-4 py-2.5 border-2 rounded-xl text-sm focus:border-gold-500 focus:outline-none"/></div>
                    <div class="flex gap-3">
                        <button class="save-settings flex-1 py-3 btn-gold rounded-xl font-bold export-action-btn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <button class="test-sheets-btn px-5 py-3 bg-gray-800 text-white rounded-xl font-bold hover:bg-gray-700 transition">üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
                        <button class="close-settings px-5 py-3 border-2 border-gray-200 rounded-xl font-medium">‡∏õ‡∏¥‡∏î</button>
                    </div>
                `:''}
                ${activeTab==='supabase'?`
                    <div class="mb-4 p-3 rounded-lg ${hasSupa?'bg-green-50 border border-green-200':'bg-gray-50 border border-gray-200'}">
                        <span class="text-sm">${hasSupa?'üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ‡πÅ‡∏•‡πâ‡∏ß':'‚ö™ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase'}</span>
                    </div>
                    <div class="space-y-4 mb-5">
                        <div><label class="block text-sm font-bold mb-2">üîó Supabase URL</label>
                        <input type="text" id="supabase-url" value="${this.state.supabaseUrl}" placeholder="https://xxxx.supabase.co" class="w-full px-4 py-2.5 border-2 rounded-xl text-sm focus:border-gold-500 focus:outline-none"/></div>
                        <div><label class="block text-sm font-bold mb-2">üîë Supabase Anon Key</label>
                        <input type="text" id="supabase-key" value="${this.state.supabaseKey}" placeholder="eyJhbGciOiJIUzI1NiIsInR5c..." class="w-full px-4 py-2.5 border-2 rounded-xl text-sm focus:border-gold-500 focus:outline-none"/></div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-5">
                        <div class="font-bold text-sm text-blue-800 mb-2">üìã ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase</div>
                        <div class="text-xs text-blue-700 space-y-1">
                            <p>1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <a href="https://supabase.com" target="_blank" class="underline font-bold">supabase.com</a> ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á project ‡πÉ‡∏´‡∏°‡πà (‡∏ü‡∏£‡∏µ)</p>
                            <p>2. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <strong>SQL Editor</strong> ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô SQL ‡∏ô‡∏µ‡πâ:</p>
                            <pre class="bg-gray-900 text-green-400 p-3 rounded-lg text-xs mt-2 overflow-x-auto">CREATE TABLE orders (
  id bigint PRIMARY KEY,
  timestamp timestamptz,
  items jsonb,
  subtotal numeric,
  total_cost numeric,
  discount numeric,
  vat numeric,
  total numeric,
  profit numeric,
  staff_id text,
  staff_name text
);</pre>
                            <p class="mt-2">3. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <strong>Settings ‚Üí API</strong> ‚Üí ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡πÅ‡∏•‡∏∞ anon key</p>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button class="save-supabase flex-1 py-3 btn-gold rounded-xl font-bold export-action-btn">‚òÅÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Supabase</button>
                        <button class="close-settings px-5 py-3 border-2 border-gray-200 rounded-xl font-medium">‡∏õ‡∏¥‡∏î</button>
                    </div>
                `:''}
                </div>
            </div>
        </div>`;
    }

    // ==================== USER MANAGEMENT MODAL ====================
    renderUserMgmtModal() {
        const users=this.auth.users;
        const roleLabel={owner:'‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á',manager:'‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£',staff:'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'};
        const roleCls={owner:'role-owner',manager:'role-manager',staff:'role-staff'};
        return `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl max-w-2xl w-full mx-4" style="max-height:90vh;overflow-y:auto">
                <div class="flex items-center justify-between p-5 border-b border-gray-100">
                    <h2 class="text-lg font-bold">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
                    <div class="flex gap-2">
                        <button class="add-user-btn px-4 py-2 text-sm font-bold text-white rounded-xl" style="background:linear-gradient(135deg,#C9A96E,#b08a4a)">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
                        <button class="close-user-mgmt text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                    </div>
                </div>
                <div class="p-5">
                    ${this.state.showAddUser?`
                    <div class="bg-gold-50 border border-gold-200 rounded-xl p-4 mb-5">
                        <div class="font-bold text-sm mb-3">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div><label class="text-xs font-bold mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label><input id="new-username" type="text" class="w-full px-3 py-2 border-2 rounded-lg text-sm focus:border-gold-500 focus:outline-none" placeholder="username"></div>
                            <div><label class="text-xs font-bold mb-1 block">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input id="new-password" type="text" class="w-full px-3 py-2 border-2 rounded-lg text-sm focus:border-gold-500 focus:outline-none" placeholder="password"></div>
                            <div><label class="text-xs font-bold mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</label><input id="new-name" type="text" class="w-full px-3 py-2 border-2 rounded-lg text-sm focus:border-gold-500 focus:outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢"></div>
                            <div><label class="text-xs font-bold mb-1 block">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</label><select id="new-role" class="w-full px-3 py-2 border-2 rounded-lg text-sm focus:border-gold-500 focus:outline-none"><option value="staff">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option><option value="manager">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</option><option value="owner">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</option></select></div>
                        </div>
                        <div class="flex gap-2">
                            <button class="confirm-add-user px-4 py-2 text-sm font-bold text-white rounded-lg" style="background:#107c10">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                            <button class="cancel-add-user px-4 py-2 text-sm border-2 border-gray-300 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>
                    </div>
                    `:''}
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50"><tr>
                            <th class="px-4 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠</th><th class="px-4 py-2 text-left">Username</th>
                            <th class="px-4 py-2 text-left">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th><th class="px-4 py-2 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr></thead>
                        <tbody>${users.map(u=>`<tr class="border-t ${u.id===this.auth.currentUser?.id?'bg-gold-50':'hover:bg-gray-50'}">
                            <td class="px-4 py-3 font-medium">${u.name}${u.id===this.auth.currentUser?.id?' <span class="text-xs text-gold-600">(‡∏Ñ‡∏∏‡∏ì)</span>':''}</td>
                            <td class="px-4 py-3 text-gray-500">${u.username}</td>
                            <td class="px-4 py-3"><span class="role-badge ${roleCls[u.role]||''}">${roleLabel[u.role]||u.role}</span></td>
                            <td class="px-4 py-3 text-center">
                                ${u.id!==this.auth.currentUser?.id?`<button data-delete-user="${u.id}" class="delete-user-btn text-red-500 hover:text-red-700 text-xs px-2 py-1 border border-red-200 rounded-lg">‡∏•‡∏ö</button>`:'<span class="text-xs text-gray-400">‚Äî</span>'}
                            </td>
                        </tr>`).join('')}</tbody>
                    </table>
                    <div class="mt-4 p-3 bg-gray-50 rounded-xl text-xs text-gray-500">
                        <div class="font-bold mb-1">üìã ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</div>
                        <div>‚Ä¢ <span class="role-badge role-owner">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</span> ‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á + ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ + ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</div>
                        <div class="mt-1">‚Ä¢ <span class="role-badge role-manager">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</span> ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div class="mt-1">‚Ä¢ <span class="role-badge role-staff">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span> ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
                    </div>
                </div>
            </div>
        </div>`;
    }

    // ==================== IMAGE MANAGEMENT MODAL ====================
    renderImageMgmtModal() {
        const p=this.state.imageProduct; if(!p)return'';
        const hasImg=!!this.getProductImage(p.id);
        return `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold">üì∑ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <button class="close-image-mgmt text-gray-500 text-xl">‚úï</button>
                </div>
                <div class="text-center mb-4">
                    <div class="text-4xl mb-1">${p.image}</div>
                    <div class="font-bold text-sm">${p.name}</div>
                    <div class="text-gray-500 text-sm">‡∏ø${p.price}</div>
                </div>
                ${hasImg?`<div class="mb-4 text-center"><img src="${this.getProductImage(p.id)}" class="w-32 h-32 object-cover rounded-xl mx-auto border-2 border-gold-200"></div>`:''}
                <div class="img-upload-zone mb-4" id="img-drop-zone">
                    <input type="file" id="img-file-input" accept="image/*" class="hidden">
                    <div class="text-2xl mb-1">üì∑</div>
                    <div class="text-sm font-medium text-gray-600">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
                    <div class="text-xs text-gray-400 mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG, WEBP (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2MB)</div>
                    <div class="text-xs text-orange-500 mt-1">‚ö†Ô∏è ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Offline ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å URL ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á Emoji ‡πÅ‡∏ó‡∏ô</div>
                </div>
                <div class="flex gap-2">
                    <button class="pick-img-btn flex-1 py-2.5 text-sm font-bold text-white rounded-xl" style="background:linear-gradient(135deg,#C9A96E,#b08a4a)">üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</button>
                    ${hasImg?`<button class="remove-img-btn px-4 py-2.5 text-sm border-2 border-red-200 text-red-500 rounded-xl font-medium">üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏π‡∏õ</button>`:''}
                    <button class="close-image-mgmt px-4 py-2.5 text-sm border-2 border-gray-200 rounded-xl">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>`;
    }

    // ==================== DEMO MODAL ====================
    renderDemoModal() {
        return `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-6 max-w-lg w-full mx-4 shadow-2xl">
                <div class="flex items-center justify-between mb-4"><h2 class="text-xl font-bold">üß™ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á</h2><button class="close-demo text-gray-500 hover:text-gray-700 text-2xl">‚úï</button></div>
                <div class="bg-amber-50 border border-gold-200 rounded-xl p-3 mb-5"><p class="text-xs text-gold-800">üí° ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô, Dashboard, ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≥‡πÑ‡∏£</p></div>
                <div class="space-y-4 mb-6">
                    <div><label class="block text-sm font-bold mb-2">üìÖ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</label>
                    <div class="flex gap-2">${[1,2,3,6,12].map(m=>`<button data-demo-months="${m}" class="demo-month-btn px-4 py-2 border-2 rounded-xl text-sm font-medium transition ${this.state.demoMonths===m?'border-gold-500 bg-gold-50 text-gold-700':'border-gray-200 hover:border-gold-300'}">${m} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>`).join('')}</div></div>
                    <div><label class="block text-sm font-bold mb-2">üßæ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</label>
                    <div class="flex gap-2">${[['5-10','‡∏ô‡πâ‡∏≠‡∏¢'],['15-30','‡∏Å‡∏•‡∏≤‡∏á'],['30-60','‡πÄ‡∏¢‡∏≠‡∏∞'],['60-100','‡∏°‡∏≤‡∏Å‡πÜ']].map(([v,l])=>`<button data-demo-orders="${v}" class="demo-orders-btn px-4 py-2 border-2 rounded-xl text-sm font-medium transition ${this.state.demoOrdersPerDay===v?'border-gold-500 bg-gold-50 text-gold-700':'border-gray-200 hover:border-gold-300'}"><div>${l}</div><div class="text-xs text-gray-400">${v}</div></button>`).join('')}</div></div>
                    <label class="flex items-center gap-3"><input type="checkbox" id="demo-peak" ${this.state.demoPeakHour?'checked':''} class="w-4 h-4 accent-gold-500"/><span class="text-sm">‚è∞ ‡∏à‡∏≥‡∏•‡∏≠‡∏á Peak Hour</span></label>
                </div>
                <div class="flex gap-3">
                    <button class="generate-demo-btn flex-1 py-3 bg-gray-800 text-white rounded-xl font-bold transition hover:bg-gray-900">üöÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á</button>
                    <button class="close-demo px-6 py-3 border-2 border-gray-200 rounded-xl font-medium">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>`;
    }

    // ==================== REPORTS ====================
    renderReports() {
        const tab=this.state.reportTab;const months=this.getAvailableMonths();
        // Staff only sees history of their own orders
        const tabs = this.auth.can('all_reports')
            ? [{id:'dashboard',label:'üìà Dashboard'},{id:'profit',label:'üí∞ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≥‡πÑ‡∏£'},{id:'bundle',label:'üéØ ‡∏à‡∏±‡∏î‡∏ä‡∏∏‡∏î‡πÇ‡∏õ‡∏£'},{id:'stock',label:'üì¶ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å'},{id:'export',label:'üì§ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'},{id:'history',label:'üìù ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≤‡∏¢'}]
            : [{id:'history',label:'üìù ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≤‡∏¢'}];
        const activeTab = tabs.find(t=>t.id===tab)?tab:tabs[0]?.id;
        return `<div class="flex-1 p-5 overflow-auto" style="background:#f5f3ef">
            <div class="max-w-7xl mx-auto">
                <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                    <div class="flex items-center gap-3">
                        <h1 class="text-xl font-bold">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô & ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h1>
                        ${activeTab!=='export'?`<select id="month-filter" class="px-3 py-1.5 border-2 border-gold-300 rounded-lg bg-white text-sm font-medium"><option value="all" ${this.state.selectedMonth==='all'?'selected':''}>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>${months.map(m=>`<option value="${m}" ${this.state.selectedMonth===m?'selected':''}>${this.getMonthName(m)}</option>`).join('')}</select>`:''}
                    </div>
                </div>
                <div class="flex gap-1 mb-4 flex-wrap">${tabs.map(t=>`<button data-tab="${t.id}" class="tab-btn ${(activeTab||tab)===t.id?'active':''}">${t.label}</button>`).join('')}</div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                    ${activeTab==='dashboard'?this.renderDashboardTab():''}
                    ${activeTab==='profit'?this.renderProfitTab():''}
                    ${activeTab==='bundle'?this.renderBundleTab():''}
                    ${activeTab==='stock'?this.renderStockTab():''}
                    ${activeTab==='export'?this.renderExportTab():''}
                    ${activeTab==='history'?this.renderHistoryTab():''}
                </div>
            </div>
        </div>`;
    }

    renderExportTab(){const p=this.state.exportPeriod;const orders=this.getExportOrders();const stats=this.calcExportStats(orders);const label=this.getExportLabel();const availYears=[...new Set(this.state.orders.map(o=>String(new Date(o.timestamp).getFullYear())))].sort().reverse();return`<div class="p-5"><div class="bg-gold-50 border border-gold-200 rounded-xl p-5 mb-6"><h3 class="font-bold text-sm mb-3">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h3><div class="flex gap-2 mb-4">${[{id:'day',label:'üìÜ ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô'},{id:'week',label:'üìÖ ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå'},{id:'month',label:'üóìÔ∏è ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'},{id:'year',label:'üìä ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ'}].map(t=>`<button data-export-period="${t.id}" class="period-btn ${p===t.id?'active':''}">${t.label}</button>`).join('')}</div><div class="flex items-center gap-4 flex-wrap">${p==='day'?`<div class="flex items-center gap-2"><label class="text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label><input type="date" id="export-date" value="${this.state.exportDate}" class="date-input"/></div><div class="flex gap-1"><button class="date-nav-btn px-3 py-1 bg-white border rounded text-sm" data-date-nav="prev">‚óÄ</button><button class="date-nav-btn px-3 py-1 bg-gold-500 text-white rounded text-sm" data-date-nav="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button><button class="date-nav-btn px-3 py-1 bg-white border rounded text-sm" data-date-nav="next">‚ñ∂</button></div>`:''} ${p==='week'?`<input type="week" id="export-week" value="${this.state.exportWeek}" class="date-input"/>`:''} ${p==='month'?`<input type="month" id="export-month" value="${this.state.exportMonth}" class="date-input"/>`:''} ${p==='year'?`<select id="export-year" class="date-input">${availYears.map(y=>`<option value="${y}" ${this.state.exportYear===y?'selected':''}>${parseInt(y)+543}</option>`).join('')}</select>`:''}<div class="ml-auto text-sm font-medium text-gold-700">üìã ${label}</div></div></div><div class="grid grid-cols-5 gap-3 mb-6"><div class="bg-white p-4 rounded-xl border text-center"><div class="text-xs text-emerald-800">üí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div><div class="text-xl font-bold text-emerald-800">‡∏ø${stats.revenue.toFixed(0)}</div></div><div class="bg-white p-4 rounded-xl border text-center"><div class="text-xs text-navy-500">üìà ‡∏Å‡∏≥‡πÑ‡∏£</div><div class="text-xl font-bold text-navy-500">‡∏ø${stats.profit.toFixed(0)}</div></div><div class="bg-white p-4 rounded-xl border text-center"><div class="text-xs text-gray-700">üßæ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div><div class="text-xl font-bold text-gray-700">${stats.orderCount}</div></div><div class="bg-white p-4 rounded-xl border text-center"><div class="text-xs text-gold-700">üì¶ ‡∏ä‡∏¥‡πâ‡∏ô</div><div class="text-xl font-bold text-gold-700">${stats.items}</div></div><div class="bg-white p-4 rounded-xl border text-center"><div class="text-xs text-gold-700">% ‡∏Å‡∏≥‡πÑ‡∏£</div><div class="text-xl font-bold text-gold-700">${stats.margin.toFixed(1)}%</div></div></div><div class="bg-gray-50 rounded-xl p-5 border-2 border-dashed border-gray-300"><h3 class="font-bold text-sm mb-3">üì§ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏Å</h3><div class="flex gap-3 flex-wrap"><button class="export-period-csv export-action-btn bg-green-500 text-white hover:bg-emerald-800">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button><button class="export-period-sheets export-action-btn bg-blue-500 text-white hover:bg-navy-600">üìä ‡∏™‡πà‡∏á‡πÑ‡∏õ Google Drive</button></div><div class="text-xs text-gray-500 mt-3">üí° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞ Export: <strong>${label}</strong> (${orders.length} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå)</div></div></div>`;}

    renderProfitTab(){const a=this.getProductAnalytics();if(!a.length)return'<div class="p-8 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';const mxQ=Math.max(...a.map(p=>p.quantity)),mxP=Math.max(...a.map(p=>p.profitPerUnit));const cl=a.map(p=>({...p,signal:this.classifyProduct(p,mxQ,mxP)}));const stars=cl.filter(p=>p.signal.label.includes('Star')),reviews=cl.filter(p=>p.signal.label.includes('Review'));return`<div class="p-5"><div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-5"><h3 class="font-bold text-sm mb-2">üí° BCG Matrix</h3><div class="grid grid-cols-4 gap-3 text-xs"><div class="flex items-center gap-2"><span class="px-2 py-1 rounded signal-star text-xs">‚≠ê Star</span> ‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ+‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏π‡∏á</div><div class="flex items-center gap-2"><span class="px-2 py-1 rounded signal-keep text-xs">üîÑ Volume</span> ‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏Å‡∏≥‡πÑ‡∏£‡∏ô‡πâ‡∏≠‡∏¢</div><div class="flex items-center gap-2"><span class="px-2 py-1 rounded signal-warn text-xs">üíé Niche</span> ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏π‡∏á‡∏Ç‡∏≤‡∏¢‡∏ô‡πâ‡∏≠‡∏¢</div><div class="flex items-center gap-2"><span class="px-2 py-1 rounded signal-drop text-xs">‚ö†Ô∏è Review</span> ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏•‡∏¥‡∏Å</div></div></div><div class="overflow-x-auto"><table class="w-full text-xs"><thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì</th><th class="px-3 py-2 text-left">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="px-3 py-2 text-left">‡∏´‡∏°‡∏ß‡∏î</th><th class="px-3 py-2 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="px-3 py-2 text-right">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th><th class="px-3 py-2 text-right">‡∏Å‡∏≥‡πÑ‡∏£/‡∏ä‡∏¥‡πâ‡∏ô</th><th class="px-3 py-2 text-right">%‡∏Å‡∏≥‡πÑ‡∏£</th><th class="px-3 py-2 text-right">‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°</th></tr></thead><tbody>${cl.sort((a,b)=>{const o={'‚≠ê Star':0,'üîÑ Volume':1,'üíé Niche':2,'‚ö†Ô∏è Review':3};return(o[a.signal.label]||9)-(o[b.signal.label]||9)||b.profit-a.profit;}).map(p=>`<tr class="border-t hover:bg-gray-50"><td class="px-3 py-2"><span class="px-2 py-0.5 rounded text-xs ${p.signal.cls}">${p.signal.label}</span></td><td class="px-3 py-2 font-medium">${p.name}</td><td class="px-3 py-2 text-gray-500">${this.getCategoryName(p.category)}</td><td class="px-3 py-2 text-right">${p.quantity}</td><td class="px-3 py-2 text-right">‡∏ø${p.revenue.toFixed(0)}</td><td class="px-3 py-2 text-right font-bold ${p.profitPerUnit>=30?'text-emerald-700':p.profitPerUnit>=20?'text-blue-600':'text-red-500'}">‡∏ø${p.profitPerUnit.toFixed(0)}</td><td class="px-3 py-2 text-right">${p.profitMargin.toFixed(1)}%</td><td class="px-3 py-2 text-right font-bold text-emerald-700">‡∏ø${p.profit.toFixed(0)}</td></tr>`).join('')}</tbody></table></div><div class="grid grid-cols-2 gap-6 mt-6"><div class="bg-green-50 border border-green-200 rounded-xl p-4"><h4 class="font-bold text-sm text-green-800 mb-2">‚úÖ ‡∏Ñ‡∏ß‡∏£‡πÇ‡∏ü‡∏Å‡∏±‡∏™ (${stars.length})</h4><div class="text-xs text-emerald-800 space-y-1">${stars.slice(0,5).map(p=>`<div>‚Ä¢ <strong>${p.name}</strong> ‚Äî ‡∏Å‡∏≥‡πÑ‡∏£/‡∏ä‡∏¥‡πâ‡∏ô ‡∏ø${p.profitPerUnit.toFixed(0)}, ‡∏Ç‡∏≤‡∏¢ ${p.quantity}</div>`).join('')}${!stars.length?'<div class="text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>':''}</div></div><div class="bg-red-50 border border-red-200 rounded-xl p-4"><h4 class="font-bold text-sm text-red-800 mb-2">‚ö†Ô∏è ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏•‡∏¥‡∏Å (${reviews.length})</h4><div class="text-xs text-red-700 space-y-1">${reviews.slice(0,5).map(p=>`<div>‚Ä¢ <strong>${p.name}</strong> ‚Äî ‡∏Å‡∏≥‡πÑ‡∏£/‡∏ä‡∏¥‡πâ‡∏ô ‡∏ø${p.profitPerUnit.toFixed(0)}, ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏Ñ‡πà ${p.quantity}</div>`).join('')}${!reviews.length?'<div class="text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>':''}</div></div></div></div>`;}

    renderBundleTab(){const b=this.getBundleSuggestions();const a=this.getProductAnalytics();if(!a.length)return'<div class="p-8 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';return`<div class="p-5"><div class="bg-purple-50 border border-purple-200 rounded-xl p-4 mb-5"><h3 class="font-bold text-sm mb-1">üéØ ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ + ‡∏Ç‡∏≤‡∏¢‡∏ä‡πâ‡∏≤ (‡∏•‡∏î 10%)</h3></div>${!b.length?'<div class="text-center py-8 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</div>':`<div class="grid grid-cols-2 gap-4">${b.map((x,i)=>`<div class="border-2 border-dashed border-gold-300 rounded-xl p-4 bg-gold-50"><div class="flex items-center gap-2 mb-3"><div class="w-7 h-7 bg-gold-500 text-white rounded-full flex items-center justify-center text-xs font-bold">${i+1}</div><div class="font-bold text-sm">‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${i+1}</div><span class="ml-auto text-xs px-2 py-1 bg-green-100 text-emerald-800 rounded-full">‡∏Å‡∏≥‡πÑ‡∏£ ‡∏ø${x.bundleProfit.toFixed(0)}</span></div><div class="flex items-center gap-2 mb-2"><div class="flex-1 bg-white rounded-lg p-2 text-center"><div class="text-xs text-gray-500">‚≠ê ‡∏ï‡∏±‡∏ß‡∏î‡∏∂‡∏á</div><div class="text-xs font-bold">${x.star}</div></div><div class="text-xl">+</div><div class="flex-1 bg-white rounded-lg p-2 text-center"><div class="text-xs text-gray-500">üì¶ ‡∏ï‡∏±‡∏ß‡πÄ‡∏™‡∏£‡∏¥‡∏°</div><div class="text-xs font-bold">${x.slow}</div></div></div><div class="flex items-center justify-between text-xs"><div>‡∏õ‡∏Å‡∏ï‡∏¥ <span class="line-through text-gray-400">‡∏ø${x.originalTotal}</span></div><div class="font-bold text-lg text-gold-600">‡∏ø${x.bundlePrice}</div><div class="text-emerald-700">Margin ${x.profitMargin.toFixed(0)}%</div></div></div>`).join('')}</div>`}</div>`;}

    renderStockTab(){const st=this.getStockInsights();if(!st.daily.length)return'<div class="p-8 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';return`<div class="p-5"><div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-5"><h3 class="font-bold text-sm mb-1">üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ = ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô + Buffer 30%</h3><p class="text-xs text-navy-500">üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å ${st.daysCount} ‡∏ß‡∏±‡∏ô</p></div>${st.peakHours.length?`<div class="mb-6"><h3 class="font-bold text-sm mb-3">‚è∞ Peak Hours</h3><div class="flex gap-1 flex-wrap">${Array.from({length:24},(_,h)=>{const f=st.peakHours.find(p=>p.hour===h);const c=f?f.count:0;const mx=st.peakHours[0]?.count||1;const int=c/mx;const bg=int>.7?'bg-red-500 text-white':int>.4?'bg-gold-400 text-white':int>.1?'bg-yellow-200':'bg-gray-100 text-gray-400';return`<div class="w-10 h-10 rounded-lg flex flex-col items-center justify-center text-xs ${bg}"><div class="font-bold">${String(h).padStart(2,'0')}</div><div style="font-size:9px">${c||''}</div></div>`;}).join('')}</div></div>`:''}<div class="overflow-x-auto"><table class="w-full text-xs"><thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="px-3 py-2 text-left">‡∏´‡∏°‡∏ß‡∏î</th><th class="px-3 py-2 text-right">‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</th><th class="px-3 py-2 text-right">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô</th><th class="px-3 py-2 text-right">üéØ ‡∏™‡∏ï‡πá‡∏≠‡∏Å/‡∏ß‡∏±‡∏ô</th><th class="px-3 py-2 text-center">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th></tr></thead><tbody>${st.daily.slice(0,30).map(d=>{const lv=d.avgPerDay>=5?'üî¥ ‡∏™‡∏π‡∏á':d.avgPerDay>=2?'üü° ‡∏Å‡∏•‡∏≤‡∏á':'üü¢ ‡∏ï‡πà‡∏≥';return`<tr class="border-t hover:bg-gray-50"><td class="px-3 py-2 font-medium">${d.name}</td><td class="px-3 py-2 text-gray-500">${this.getCategoryName(d.category)}</td><td class="px-3 py-2 text-right">${d.totalQty}</td><td class="px-3 py-2 text-right">${d.avgPerDay.toFixed(1)}</td><td class="px-3 py-2 text-right font-bold text-blue-600">${d.suggestedStock}</td><td class="px-3 py-2 text-center">${lv}</td></tr>`;}).join('')}</tbody></table></div></div>`;}

    renderHistoryTab(){
        const fo = this.auth.can('all_reports')
            ? this.getFilteredOrders()
            : this.state.orders.filter(o=>o.staffId===this.auth.currentUser?.id);
        return`<div class="p-5">${!fo.length?'<div class="text-center py-8 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>':`<div class="overflow-x-auto"><table class="w-full text-xs"><thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th><th class="px-3 py-2 text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="px-3 py-2 text-left">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th><th class="px-3 py-2 text-right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th class="px-3 py-2 text-right">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</th><th class="px-3 py-2 text-right">VAT</th><th class="px-3 py-2 text-right">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th><th class="px-3 py-2 text-right">‡∏Å‡∏≥‡πÑ‡∏£</th></tr></thead><tbody>${fo.map(o=>{const d=new Date(o.timestamp);return`<tr class="border-t hover:bg-gray-50"><td class="px-3 py-2"><div>${d.toLocaleDateString('th-TH')}</div><div class="text-gray-400">${d.toLocaleTimeString('th-TH')}</div></td><td class="px-3 py-2">${o.items.map(i=>`${i.name}x${i.quantity}`).join(', ')}</td><td class="px-3 py-2 text-gray-500">${o.staffName||'‚Äî'}</td><td class="px-3 py-2 text-right">‡∏ø${o.subtotal.toFixed(2)}</td><td class="px-3 py-2 text-right text-red-500">-‡∏ø${o.discount.toFixed(2)}</td><td class="px-3 py-2 text-right">‡∏ø${o.vat.toFixed(2)}</td><td class="px-3 py-2 text-right font-bold">‡∏ø${o.total.toFixed(2)}</td><td class="px-3 py-2 text-right font-bold text-emerald-700">‡∏ø${o.profit.toFixed(2)}</td></tr>`;}).join('')}</tbody></table></div>`}</div>`;
    }

    // ==================== DASHBOARD (kept from original, simplified) ====================
    renderDashboardTab() {
        const allOrders=this.getFilteredOrders();
        if(!allOrders.length) return '<div class="p-8 text-center text-gray-400"><div class="text-4xl mb-2">üìä</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ</div>';
        const dp=this.state.dashPeriod;
        const {orders,prevOrders,periodLabel,prevLabel}=this.getDashFilteredOrders(allOrders);
        const agg=this.aggregateDashboardData(orders);
        const prevAgg=prevOrders.length?this.aggregateDashboardData(prevOrders):null;
        const st=this.state.dashSubTab;
        const availMonths=this.getAvailableMonths();
        const availYears=[...new Set(allOrders.map(o=>String(new Date(o.timestamp).getFullYear())))].sort().reverse();
        const availWeeks=this.getAvailableWeeks(allOrders);
        return`<div><div style="background:#faf9f6;border-bottom:1px solid #eae7e0;padding:10px 20px;display:flex;align-items:center;gap:10px;flex-wrap:wrap"><span style="font-size:11px;color:#888;font-weight:600">üîΩ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</span><div style="display:flex;gap:4px">${[{id:'all',l:'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'},{id:'day',l:'üìÜ ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô'},{id:'week',l:'üìÖ ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå'},{id:'month',l:'üóì ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'},{id:'year',l:'üìä ‡∏õ‡∏µ'}].map(t=>`<button data-dash-period="${t.id}" class="fbtn-dash ${dp===t.id?'active':''}">${t.l}</button>`).join('')}</div>${dp!=='all'?`<label style="display:flex;align-items:center;gap:5px;font-size:11px;color:#666;cursor:pointer"><input type="checkbox" id="dash-compare" ${this.state.dashCompare?'checked':''} style="accent-color:#C9A96E"/>üîÑ ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ô</label>`:''}</div>
        ${dp!=='all'?`<div style="background:white;border-bottom:1px solid #eae7e0;padding:8px 20px;display:flex;align-items:center;gap:8px;flex-wrap:wrap"><div style="flex:1;display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:8px;background:#e8f4fd;border:1px solid #b3d9f5"><span style="font-size:10px;font-weight:700;color:#0078d4">A</span>${dp==='day'?`<input type="date" id="dash-date" value="${this.state.dashDate}" class="date-input" style="font-size:12px"><div style="display:flex;gap:2px"><button class="dash-nav" data-dash-nav="prev-day" style="padding:2px 8px;border:1px solid #ddd;border-radius:4px;font-size:10px;cursor:pointer;background:white">‚óÄ</button><button class="dash-nav" data-dash-nav="today" style="padding:2px 8px;border-radius:4px;font-size:10px;cursor:pointer;background:#0078d4;color:white;border:none">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button><button class="dash-nav" data-dash-nav="next-day" style="padding:2px 8px;border:1px solid #ddd;border-radius:4px;font-size:10px;cursor:pointer;background:white">‚ñ∂</button></div>`:''}${dp==='week'?`<select id="dash-week" class="date-input" style="font-size:12px">${availWeeks.map(w=>`<option value="${w.key}" ${w.key===this.state.dashWeekOffset+''?'selected':''}>${w.label}</option>`).join('')}</select>`:''} ${dp==='month'?`<select id="dash-month" class="date-input" style="font-size:12px">${availMonths.map(m=>`<option value="${m}" ${m===this.state.dashMonthKey?'selected':''}>${this.getMonthNameFull(m)}</option>`).join('')}</select>`:''} ${dp==='year'?`<select id="dash-year" class="date-input" style="font-size:12px">${availYears.map(y=>`<option value="${y}" ${y===this.state.dashYear?'selected':''}>${parseInt(y)+543}</option>`).join('')}</select>`:''}</div></div>`:''}
        <div style="background:white;border-bottom:1px solid #eae7e0;padding:6px 20px;font-size:11px;display:flex;gap:12px"><span style="font-weight:700;color:#0078d4">üìÖ A: ${periodLabel}</span><span style="color:#888">${orders.length.toLocaleString()} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</span></div>
        <div class="flex gap-1 px-4 pt-3" style="border-bottom:1px solid #eae7e0">${[{id:'overview',l:'üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°'},{id:'products',l:'üèÜ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'},{id:'time',l:'‚è∞ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤'},{id:'detail',l:'üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}].map(t=>`<button data-dash-sub="${t.id}" class="pbi-stab ${st===t.id?'active':''}">${t.l}</button>`).join('')}</div>
        <div class="p-5">${st==='overview'?this.renderPBIOverview(agg,orders,prevAgg):''}${st==='products'?this.renderPBIProducts(agg,orders):''}${st==='time'?this.renderPBITime(agg):''}${st==='detail'?this.renderPBIDetail(agg):''}</div></div>`;
    }

    getAvailableWeeks(orders){const weeks=[];if(!orders.length)return weeks;const dates=orders.map(o=>new Date(o.timestamp)).sort((a,b)=>b-a);const now=new Date();now.setHours(0,0,0,0);const day=now.getDay();const diff=now.getDate()-day+(day===0?-6:1);const thisMonday=new Date(now);thisMonday.setDate(diff);const earliest=new Date(Math.min(...dates));earliest.setHours(0,0,0,0);let d=new Date(thisMonday);let offset=0;while(d>=earliest&&offset<52){const end=new Date(d);end.setDate(d.getDate()+6);const dd=d.getDate(),mm=d.getMonth()+1,dd2=end.getDate(),mm2=end.getMonth()+1;const mTh=['','‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];weeks.push({key:String(offset),label:`${dd} ${mTh[mm]} - ${dd2} ${mTh[mm2]} ${end.getFullYear()+543}`,start:new Date(d),end:new Date(end)});d.setDate(d.getDate()-7);offset++;}return weeks;}

    getDashFilteredOrders(allOrders){const dp=this.state.dashPeriod;const mTh=['','‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];const fmtDate=(dk)=>{const[y,m,d]=dk.split('-');return`${parseInt(d)} ${mTh[parseInt(m)]} ${parseInt(y)+543}`;};if(dp==='all')return{orders:allOrders,prevOrders:[],periodLabel:'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',prevLabel:''};if(dp==='day'){const dk=this.state.dashDate;const orders=allOrders.filter(o=>o.timestamp.startsWith(dk));const dk2=this.state.dashDate2;const prevOrders=this.state.dashCompare?allOrders.filter(o=>o.timestamp.startsWith(dk2)):[];return{orders,prevOrders,periodLabel:fmtDate(dk),prevLabel:fmtDate(dk2)};}if(dp==='week'){const weeks=this.getAvailableWeeks(allOrders);const fW=(offset)=>{const w=weeks.find(w=>w.key===String(offset));if(!w)return{orders:[],label:'‚Äî'};const s=new Date(w.start);s.setHours(0,0,0,0);const e=new Date(w.end);e.setHours(23,59,59,999);return{orders:allOrders.filter(o=>{const t=new Date(o.timestamp);return t>=s&&t<=e;}),label:w.label};};const a=fW(parseInt(this.state.dashWeekOffset)||0);const b=this.state.dashCompare?fW(parseInt(this.state.dashWeekOffset2)||1):{orders:[],label:''};return{orders:a.orders,prevOrders:b.orders,periodLabel:a.label,prevLabel:b.label};}if(dp==='month'){const mk=this.state.dashMonthKey;const orders=allOrders.filter(o=>{const d=new Date(o.timestamp);return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`===mk;});const mk2=this.state.dashMonthKey2;const prevOrders=this.state.dashCompare?allOrders.filter(o=>{const d=new Date(o.timestamp);return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`===mk2;}):[];return{orders,prevOrders,periodLabel:this.getMonthNameFull(mk),prevLabel:this.getMonthNameFull(mk2)};}if(dp==='year'){const yk=this.state.dashYear;const orders=allOrders.filter(o=>o.timestamp.startsWith(yk));const yk2=this.state.dashYear2;const prevOrders=this.state.dashCompare?allOrders.filter(o=>o.timestamp.startsWith(yk2)):[];return{orders,prevOrders,periodLabel:`‡∏õ‡∏µ ‡∏û.‡∏®. ${parseInt(yk)+543}`,prevLabel:`‡∏õ‡∏µ ‡∏û.‡∏®. ${parseInt(yk2)+543}`};}return{orders:allOrders,prevOrders:[],periodLabel:'',prevLabel:''};}

    aggregateDashboardData(orders){const daily={},hourly={},prodMap={},catMap={};orders.forEach(o=>{const d=new Date(o.timestamp);const dk=d.toISOString().split('T')[0];const h=d.getHours();if(!daily[dk])daily[dk]={date:dk,rev:0,cost:0,profit:0,orders:0,items:0};daily[dk].rev+=o.total;daily[dk].cost+=o.totalCost;daily[dk].profit+=o.profit;daily[dk].orders++;daily[dk].items+=o.items.reduce((s,i)=>s+i.quantity,0);if(!hourly[h])hourly[h]={hour:h,rev:0,orders:0};hourly[h].rev+=o.total;hourly[h].orders++;o.items.forEach(item=>{const k=item.originalName||item.name;if(!prodMap[k])prodMap[k]={name:k,catKey:item.category,cat:this.getCategoryName(item.category),qty:0,rev:0,cost:0,profit:0};prodMap[k].qty+=item.quantity;prodMap[k].rev+=item.price*item.quantity;prodMap[k].cost+=item.cost*item.quantity;prodMap[k].profit+=(item.price-item.cost)*item.quantity;const ck=item.category;if(!catMap[ck])catMap[ck]={name:this.getCategoryName(ck),catKey:ck,rev:0,qty:0,profit:0,color:({coffee:'#0078d4',tea:'#107c10',softdrink:'#d83b01',bakery:'#8764b8',promotion:'#f2a500',other:'#8a8886'})[ck]||'#ccc'};catMap[ck].rev+=item.price*item.quantity;catMap[ck].qty+=item.quantity;catMap[ck].profit+=(item.price-item.cost)*item.quantity;});});const dailyArr=Object.values(daily).sort((a,b)=>a.date.localeCompare(b.date));return{daily:dailyArr,hourly:Object.values(hourly).sort((a,b)=>a.hour-b.hour),prodMap,catMap,totalOrders:orders.length,totalRev:orders.reduce((s,o)=>s+o.total,0),totalProfit:orders.reduce((s,o)=>s+o.profit,0),totalItems:orders.reduce((s,o)=>s+o.items.reduce((ss,i)=>ss+i.quantity,0),0),totalCost:orders.reduce((s,o)=>s+o.totalCost,0)};}

    renderPBIOverview(agg,orders,prevAgg){const{daily,catMap,totalOrders,totalRev,totalProfit,totalItems}=agg;const days=Math.max(daily.length,1);const margin=totalRev>0?(totalProfit/totalRev*100):0;const pRev=prevAgg?.totalRev||0,pProfit=prevAgg?.totalProfit||0,pOrders=prevAgg?.totalOrders||0,pItems=prevAgg?.totalItems||0;const cmp=(a,b)=>{if(!b)return'';const d=((a-b)/b*100).toFixed(1);return d>0?`<span class="pbi-badge up">‚ñ≤${d}%</span>`:`<span class="pbi-badge dn">‚ñº${Math.abs(d)}%</span>`;};const cats=Object.entries(catMap).sort((a,b)=>b[1].rev-a[1].rev);const catTotal=cats.reduce((s,[,c])=>s+c.rev,0);return`<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px"><div class="pbi-kpi c1"><div style="font-size:18px;margin-bottom:2px">üí∞</div><div style="font-size:10px;color:#888">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div><div style="font-size:24px;font-weight:700">‡∏ø${Math.round(totalRev).toLocaleString()}</div><div style="display:flex;align-items:center;gap:6px;margin-top:4px"><span class="pbi-badge up">${days} ‡∏ß‡∏±‡∏ô</span>${cmp(totalRev,pRev)}<span style="font-size:9px;color:#aaa">~‡∏ø${Math.round(totalRev/days).toLocaleString()}/‡∏ß‡∏±‡∏ô</span></div></div><div class="pbi-kpi c2"><div style="font-size:18px;margin-bottom:2px">üìà</div><div style="font-size:10px;color:#888">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div><div style="font-size:24px;font-weight:700">‡∏ø${Math.round(totalProfit).toLocaleString()}</div><div style="display:flex;align-items:center;gap:6px;margin-top:4px"><span class="pbi-badge up">Margin ${margin.toFixed(1)}%</span>${cmp(totalProfit,pProfit)}</div></div><div class="pbi-kpi c3"><div style="font-size:18px;margin-bottom:2px">üßæ</div><div style="font-size:10px;color:#888">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div><div style="font-size:24px;font-weight:700">${totalOrders.toLocaleString()}</div><div style="display:flex;align-items:center;gap:6px;margin-top:4px"><span class="pbi-badge neu">~${Math.round(totalOrders/days)}/‡∏ß‡∏±‡∏ô</span>${cmp(totalOrders,pOrders)}</div></div><div class="pbi-kpi c4"><div style="font-size:18px;margin-bottom:2px">üì¶</div><div style="font-size:10px;color:#888">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô</div><div style="font-size:24px;font-weight:700">${totalItems.toLocaleString()}</div><div style="display:flex;align-items:center;gap:6px;margin-top:4px"><span class="pbi-badge neu">~${Math.round(totalItems/days)}/‡∏ß‡∏±‡∏ô</span>${cmp(totalItems,pItems)}</div></div></div><div style="display:grid;grid-template-columns:3fr 2fr;gap:12px;margin-bottom:14px"><div class="pbi-card"><div class="pbi-card-header"><div class="pbi-card-title">üìâ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div><div class="pbi-actions"><button class="pbi-abtn ${(this._pbiLineMode||'rev')==='rev'?'active':''}" data-line-mode="rev">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</button><button class="pbi-abtn ${this._pbiLineMode==='profit'?'active':''}" data-line-mode="profit">‡∏Å‡∏≥‡πÑ‡∏£</button><button class="pbi-abtn ${this._pbiLineMode==='orders'?'active':''}" data-line-mode="orders">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button></div></div><canvas id="pbiLineChart" height="130"></canvas></div><div class="pbi-card"><div class="pbi-card-header"><div class="pbi-card-title">üç© ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div><div class="pbi-actions"><button class="pbi-abtn active" data-donut-mode="rev">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</button><button class="pbi-abtn" data-donut-mode="qty">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</button></div></div><div style="display:flex;gap:12px;align-items:center"><canvas id="pbiDonutChart" width="120" height="120" style="flex-shrink:0"></canvas><div style="flex:1">${cats.map(([k,c])=>`<div class="dl-row"><div class="dl-dot" style="background:${c.color}"></div><div style="font-size:11px;flex:1">${c.name}</div><div style="font-size:11px;font-weight:700">‡∏ø${Math.round(c.rev).toLocaleString()}</div><div style="font-size:10px;color:#888;min-width:35px;text-align:right">${catTotal>0?(c.rev/catTotal*100).toFixed(1):0}%</div></div>`).join('')}</div></div></div></div><div class="pbi-card"><div class="pbi-card-header"><div class="pbi-card-title">üìä ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div></div><canvas id="pbiBarChart" height="90"></canvas></div>`;}

    renderPBIProducts(agg){const tc=this.state.dashTopCat;const allProds=Object.values(agg.prodMap);const filtered=tc==='all'?allProds:allProds.filter(p=>p.catKey===tc);const top=filtered.sort((a,b)=>b.qty-a.qty).slice(0,10);const maxQty=top.length?Math.max(...top.map(p=>p.qty)):1;return`<div style="display:flex;gap:5px;margin-bottom:14px;flex-wrap:wrap;align-items:center"><span style="font-size:11px;color:#888;font-weight:600">üì¶ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</span><button data-dtop-cat="all" class="fbtn-dash ${tc==='all'?'active':''}">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>${this.categories.map(c=>`<button data-dtop-cat="${c.id}" class="fbtn-dash ${tc===c.id?'active':''}">${c.icon} ${c.name}</button>`).join('')}</div>${!top.length?'<div class="text-center py-8 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>':`<div class="space-y-2">${top.map((p,i)=>`<div class="bar-container"><div class="bar-label">${['ü•á','ü•à','ü•â'][i]||`${i+1}.`} ${p.name}</div><div class="bar-track"><div class="bar-fill" style="width:${(p.qty/maxQty*100).toFixed(1)}%"><span class="bar-value">${p.qty} ‡∏ä‡∏¥‡πâ‡∏ô | ‡∏ø${Math.round(p.rev).toLocaleString()}</span></div></div></div>`).join('')}</div>`}`;}

    renderPBITime(agg){const {hourly}=agg;if(!hourly.length)return'<div class="text-center py-8 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';const maxH=Math.max(...hourly.map(h=>h.orders));return`<div class="mb-6"><h4 class="font-bold text-sm mb-3">‚è∞ Peak Hours (‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</h4><div class="flex gap-1 flex-wrap">${Array.from({length:24},(_,h)=>{const f=hourly.find(x=>x.hour===h);const c=f?f.orders:0;const int=c/maxH;const bg=int>.7?'bg-red-500 text-white':int>.4?'bg-gold-400 text-white':int>.1?'bg-yellow-200':'bg-gray-100 text-gray-400';return`<div class="w-10 h-10 rounded-lg flex flex-col items-center justify-center text-xs ${bg}"><div class="font-bold">${String(h).padStart(2,'0')}</div><div style="font-size:9px">${c||''}</div></div>`;}).join('')}</div></div><canvas id="pbiTimeChart" height="100"></canvas>`;}

    renderPBIDetail(agg){const {daily}=agg;if(!daily.length)return'<div class="text-center py-8 text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';return`<div class="overflow-x-auto"><table class="w-full text-xs"><thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="px-3 py-2 text-right">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</th><th class="px-3 py-2 text-right">‡∏ä‡∏¥‡πâ‡∏ô</th><th class="px-3 py-2 text-right">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th><th class="px-3 py-2 text-right">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th><th class="px-3 py-2 text-right">‡∏Å‡∏≥‡πÑ‡∏£</th><th class="px-3 py-2 text-right">%‡∏Å‡∏≥‡πÑ‡∏£</th></tr></thead><tbody>${daily.map(d=>`<tr class="border-t hover:bg-gray-50"><td class="px-3 py-2">${new Date(d.date+'T12:00:00').toLocaleDateString('th-TH',{weekday:'short',day:'numeric',month:'short'})}</td><td class="px-3 py-2 text-right">${d.orders}</td><td class="px-3 py-2 text-right">${d.items}</td><td class="px-3 py-2 text-right font-bold">‡∏ø${Math.round(d.rev).toLocaleString()}</td><td class="px-3 py-2 text-right text-red-500">‡∏ø${Math.round(d.cost).toLocaleString()}</td><td class="px-3 py-2 text-right font-bold text-emerald-700">‡∏ø${Math.round(d.profit).toLocaleString()}</td><td class="px-3 py-2 text-right ${d.rev>0&&d.profit/d.rev>.3?'text-emerald-700':'text-gray-600'}">${d.rev>0?(d.profit/d.rev*100).toFixed(1):0}%</td></tr>`).join('')}</tbody></table></div>`;}

    initDashboardCharts(){
        if(this.state.currentView!=='reports'||this.state.reportTab!=='dashboard')return;
        if(!document.getElementById('pbiLineChart'))return;
        const allOrders=this.getFilteredOrders();if(!allOrders.length)return;
        const {orders}=this.getDashFilteredOrders(allOrders);
        const agg=this.aggregateDashboardData(orders);
        if(this._pbiCharts){Object.values(this._pbiCharts).forEach(c=>{try{c.destroy();}catch(e){}});} this._pbiCharts={};
        const mode=this._pbiLineMode||'rev';
        const lineEl=document.getElementById('pbiLineChart');
        if(lineEl){const ctx=lineEl.getContext('2d');const labels=agg.daily.map(d=>new Date(d.date+'T12:00:00').toLocaleDateString('th-TH',{day:'numeric',month:'short'}));const data=agg.daily.map(d=>mode==='profit'?d.profit:mode==='orders'?d.orders:d.rev);this._pbiCharts.line=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:mode==='profit'?'‡∏Å‡∏≥‡πÑ‡∏£':mode==='orders'?'‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå':'‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢',data,borderColor:'#0078d4',backgroundColor:'#0078d410',fill:true,tension:.3,pointRadius:2,borderWidth:2}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`‡∏ø${Math.round(c.parsed.y).toLocaleString()}`}}},scales:{x:{ticks:{font:{size:9},maxTicksLimit:10},grid:{display:false}},y:{ticks:{font:{size:9},callback:v=>'‡∏ø'+Math.round(v).toLocaleString()},grid:{color:'#f5f3ef'}}}}});}
        const donutEl=document.getElementById('pbiDonutChart');
        if(donutEl){const ctx=donutEl.getContext('2d');const cats=Object.values(agg.catMap);const mode2=this._pbiDonutMode||'rev';this._pbiCharts.donut=new Chart(ctx,{type:'doughnut',data:{labels:cats.map(c=>c.name),datasets:[{data:cats.map(c=>mode2==='qty'?c.qty:c.rev),backgroundColor:cats.map(c=>c.color),borderWidth:2,borderColor:'white'}]},options:{responsive:false,plugins:{legend:{display:false}}}});}
        const barEl=document.getElementById('pbiBarChart');
        if(barEl){const ctx=barEl.getContext('2d');const labels=agg.daily.map(d=>new Date(d.date+'T12:00:00').toLocaleDateString('th-TH',{day:'numeric',month:'short'}));this._pbiCharts.bar=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢',data:agg.daily.map(d=>d.rev),backgroundColor:'#C9A96E55',borderColor:'#C9A96E',borderWidth:1},{label:'‡∏Å‡∏≥‡πÑ‡∏£',data:agg.daily.map(d=>d.profit),backgroundColor:'#107c1055',borderColor:'#107c10',borderWidth:1}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{labels:{font:{size:9}}}},scales:{x:{ticks:{font:{size:9},maxTicksLimit:14},grid:{display:false}},y:{ticks:{font:{size:9},callback:v=>'‡∏ø'+Math.round(v).toLocaleString()},grid:{color:'#f5f3ef'}}}}});}
        const timeEl=document.getElementById('pbiTimeChart');
        if(timeEl){const ctx=timeEl.getContext('2d');const hrs=Array.from({length:24},(_,h)=>h);const data=hrs.map(h=>{const f=agg.hourly.find(x=>x.hour===h);return f?f.orders:0;});this._pbiCharts.time=new Chart(ctx,{type:'bar',data:{labels:hrs.map(h=>`${String(h).padStart(2,'0')}:00`),datasets:[{label:'‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå',data,backgroundColor:data.map(v=>v===Math.max(...data)?'#C9A96E':'#e0ddd8'),borderRadius:4}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:8},maxTicksLimit:12},grid:{display:false}},y:{ticks:{font:{size:9},stepSize:1},grid:{color:'#f5f3ef'}}}}});}
    }

    // ==================== DEMO DATA GENERATOR ====================
    generateDemoData(){const[minOrders,maxOrders]=this.state.demoOrdersPerDay.split('-').map(Number);const months=this.state.demoMonths;const usePeak=this.state.demoPeakHour;const coffeeP=this.products.filter(p=>p.category==='coffee');const teaP=this.products.filter(p=>p.category==='tea');const softP=this.products.filter(p=>p.category==='softdrink');const bakeryP=this.products.filter(p=>p.category==='bakery');const otherP=this.products.filter(p=>p.category==='other'&&!p.isAddon);const promoP=this.products.filter(p=>p.category==='promotion');const allDrinks=[...coffeeP,...teaP,...softP];const allFood=[...bakeryP,...otherP,...promoP];const topDrinks=['‡∏•‡∏≤‡πÄ‡∏ï‡πâ ‡πÄ‡∏¢‡πá‡∏ô','‡∏Ñ‡∏≤‡∏õ‡∏π‡∏ä‡∏¥‡πÇ‡∏ô‡πà ‡πÄ‡∏¢‡πá‡∏ô','‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà ‡πÄ‡∏¢‡πá‡∏ô','‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏¢‡πá‡∏ô','‡∏°‡∏≠‡∏Ñ‡∏Ñ‡πà‡∏≤ ‡πÄ‡∏¢‡πá‡∏ô','‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏±‡∏ó‡∏â‡∏∞ ‡πÄ‡∏¢‡πá‡∏ô','‡∏™‡πâ‡∏°‡∏™‡∏°‡∏π‡∏ó‡∏ï‡∏µ‡πâ'];const topFood=['‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏õ‡∏¥‡πâ‡∏á‡πÄ‡∏ô‡∏¢+‡∏ô‡∏°','‡πÄ‡∏Ñ‡πâ‡∏Å‡∏ä‡πá‡∏≠‡∏Ñ‡πÇ‡∏Å‡πÅ‡∏•‡∏ï','‡πÅ‡∏ã‡∏ô‡∏ß‡∏¥‡∏ä‡πÅ‡∏Æ‡∏°‡∏ä‡∏µ‡∏™','‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏´‡∏ç‡πà','‡∏ß‡∏≤‡∏ü‡πÄ‡∏ü‡∏¥‡∏•'];function wPool(items,tops){const p=[];items.forEach(i=>{const w=tops.includes(i.name)?4:1;for(let x=0;x<w;x++)p.push(i);});return p;}const drinkPool=wPool(allDrinks,topDrinks);const foodPool=wPool(allFood,topFood);function rand(min,max){return Math.floor(Math.random()*(max-min+1))+min;}function pick(arr){return arr[rand(0,arr.length-1)];}const sweets=[0,25,50,75,100];function rSweet(){return sweets[rand(0,sweets.length-1)];}const peakHours=usePeak?[7,8,9,11,12,13,15,16,17]:Array.from({length:14},(_,i)=>i+7);const newOrders=[];let totalGenerated=0;const startDate=new Date();startDate.setMonth(startDate.getMonth()-months);startDate.setHours(0,0,0,0);const currentDate=new Date(startDate);while(currentDate<=new Date()){const numOrders=rand(minOrders,maxOrders);for(let j=0;j<numOrders;j++){const orderTime=new Date(currentDate);const h=pick(peakHours);orderTime.setHours(h,rand(0,59),rand(0,59),0);const itemCount=rand(1,3);const items=[];for(let k=0;k<itemCount;k++){const isDrinkItem=Math.random()<.7;const product=isDrinkItem?pick(drinkPool):pick(foodPool);const qty=Math.random()<.85?1:2;let oi={...product,quantity:qty};if(product.isDrink){const sw=rSweet();oi.originalName=product.name;oi.name=`${product.name} (${sw}%)`;oi.sweetness=sw;}if(product.isDrink&&product.category==='coffee'&&Math.random()<.15){oi.extraShots=1;oi.price=product.price+10;}const ei=items.findIndex(it=>it.name===oi.name);if(ei>=0)items[ei].quantity+=qty;else items.push(oi);}const sub=items.reduce((s,it)=>s+it.price*it.quantity,0);const tc=items.reduce((s,it)=>s+it.cost*it.quantity,0);const disc=(sub*10)/100;const vat=(sub-disc)*.07;const tot=sub-disc+vat;const prof=tot-tc;newOrders.push({id:orderTime.getTime()+rand(0,999),timestamp:orderTime.toISOString(),items,subtotal:sub,totalCost:tc,discount:disc,vat,total:tot,profit:prof,staffName:'Demo'});totalGenerated++;}currentDate.setDate(currentDate.getDate()+1);}newOrders.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));this._clearIDB();this.state.orders=newOrders;this._saveBatch(newOrders);this.state.showDemoGenerator=false;const tRev=newOrders.reduce((s,o)=>s+o.total,0);const tProf=newOrders.reduce((s,o)=>s+o.profit,0);alert(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\nüìä ${totalGenerated.toLocaleString()} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå\nüí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ ‡∏ø${tRev.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',')}\nüìà ‡∏Å‡∏≥‡πÑ‡∏£ ‡∏ø${tProf.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',')}`);this.render();}
    clearAllData(){if(confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?\n‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!')){this.state.orders=[];this._clearIDB();alert('üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');this.render();}}

    // ==================== BIND LOGIN EVENTS ====================
    bindLoginEvents() {
        const doLogin=()=>{
            const u=document.getElementById('login-username')?.value?.trim();
            const p=document.getElementById('login-password')?.value;
            if(!u||!p){this.state.loginError='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';this.render();return;}
            const user=this.auth.login(u,p);
            if(user){this.state.loginError='';this.render();}
            else{this.state.loginError='‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';this.render();}
        };
        document.getElementById('login-btn')?.addEventListener('click',doLogin);
        document.getElementById('login-password')?.addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
    }

    // ==================== BIND EVENTS ====================
    bindEvents() {
        // Nav
        document.querySelectorAll('[data-view]').forEach(el=>el.addEventListener('click',e=>{this.state.currentView=e.currentTarget.dataset.view;this.render();}));
        document.querySelectorAll('.category-btn').forEach(el=>el.addEventListener('click',e=>{this.state.selectedCategory=e.currentTarget.dataset.category;this.render();}));
        document.querySelectorAll('.product-card').forEach(el=>el.addEventListener('click',e=>{
            if(e.target.closest('.img-upload-btn'))return;
            const p=this.products.find(p=>p.id===parseInt(e.currentTarget.dataset.productId));if(p)this.addToCart(p);
        }));
        // Image upload buttons
        document.querySelectorAll('.img-upload-btn').forEach(el=>el.addEventListener('click',e=>{
            e.stopPropagation();
            const pid=parseInt(e.currentTarget.dataset.imgProduct);
            const p=this.products.find(x=>x.id===pid);
            if(p){this.state.imageProduct=p;this.state.showImageMgmt=true;this.render();}
        }));
        // Cart
        document.querySelectorAll('[data-inc]').forEach(el=>el.addEventListener('click',e=>{e.stopPropagation();this.updateQuantity(parseInt(e.target.dataset.inc),1);}));
        document.querySelectorAll('[data-dec]').forEach(el=>el.addEventListener('click',e=>{e.stopPropagation();this.updateQuantity(parseInt(e.target.dataset.dec),-1);}));
        document.querySelectorAll('[data-remove]').forEach(el=>el.addEventListener('click',e=>{e.stopPropagation();this.removeFromCart(parseInt(e.target.dataset.remove));}));
        document.querySelectorAll('[data-addshot]').forEach(el=>el.addEventListener('click',e=>{e.stopPropagation();this.addShotToCartItem(parseInt(e.target.dataset.addshot));}));
        const cl=document.querySelector('.clear-cart');if(cl)cl.addEventListener('click',()=>this.clearCart());
        const co=document.querySelector('.checkout-btn');if(co)co.addEventListener('click',()=>this.checkout());
        // Receipt
        const cr=document.querySelector('.close-receipt-btn');if(cr)cr.addEventListener('click',()=>this.closeReceipt());
        // Sweetness
        const cs=document.querySelector('.cancel-sweetness');if(cs)cs.addEventListener('click',()=>{this.state.showSweetness=false;this.state.sweetnessProduct=null;this.render();});
        document.querySelectorAll('[data-sweet-select]').forEach(b=>b.addEventListener('click',e=>{this.addToCartWithSweetness(this.state.sweetnessProduct,parseInt(e.currentTarget.dataset.sweetSelect));}));
        // Sidebar buttons
        const stb=document.querySelector('.settings-btn');if(stb)stb.addEventListener('click',()=>{this.state.showSettings=true;this.state.settingsTab='sheets';this.render();});
        const sub=document.querySelector('.supabase-btn');if(sub)sub.addEventListener('click',()=>{this.state.showSettings=true;this.state.settingsTab='supabase';this.render();});
        const demo=document.querySelector('.demo-btn');if(demo)demo.addEventListener('click',()=>{this.state.showDemoGenerator=true;this.render();});
        const ca=document.querySelector('.clear-all-btn');if(ca)ca.addEventListener('click',()=>this.clearAllData());
        const um=document.querySelector('.user-mgmt-btn');if(um)um.addEventListener('click',()=>{this.state.showUserMgmt=true;this.render();});
        const lo=document.querySelector('.logout-btn');if(lo)lo.addEventListener('click',()=>{this.auth.logout();this.state.loginError='';this.render();});
        // Settings modal tabs
        document.querySelectorAll('[data-settings-tab]').forEach(el=>el.addEventListener('click',e=>{this.state.settingsTab=e.currentTarget.dataset.settingsTab;this.render();}));
        document.querySelectorAll('.close-settings').forEach(b=>b.addEventListener('click',()=>{this.state.showSettings=false;this.render();}));
        const sv=document.querySelector('.save-settings');if(sv)sv.addEventListener('click',()=>{
            const u=document.getElementById('google-sheet-url').value;this.state.googleSheetUrl=u;localStorage.setItem('googleSheetUrl',u);
            const ae=document.getElementById('auto-export-toggle');if(ae){this.state.autoExportSheets=ae.checked;localStorage.setItem('autoExportSheets',ae.checked);}
            this.state.showSettings=false;alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`);this.render();
        });
        const ae=document.getElementById('auto-export-toggle');if(ae)ae.addEventListener('change',e=>{this.state.autoExportSheets=e.target.checked;localStorage.setItem('autoExportSheets',e.target.checked);});
        const tb=document.querySelector('.test-sheets-btn');if(tb)tb.addEventListener('click',async()=>{if(!this.state.googleSheetUrl){alert('‚ö†Ô∏è ‡πÉ‡∏™‡πà URL ‡∏Å‡πà‡∏≠‡∏ô');return;}try{const now=new Date();await fetch(this.state.googleSheetUrl,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:[{date:now.toLocaleDateString('th-TH'),time:now.toLocaleTimeString('th-TH'),category:'TEST',item:'üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö',quantity:1,price:0,cost:0,subtotal:'0',discount:'0',vat:'0',total:'0',profit:'0',staff:'test'}],month:'test'})});alert('‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏õ‡∏¥‡∏î Google Sheet ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');}catch(e){alert('‚ùå '+e.message);}});
        const ssv=document.querySelector('.save-supabase');if(ssv)ssv.addEventListener('click',()=>{this.state.supabaseUrl=document.getElementById('supabase-url').value;this.state.supabaseKey=document.getElementById('supabase-key').value;localStorage.setItem('supabaseUrl',this.state.supabaseUrl);localStorage.setItem('supabaseKey',this.state.supabaseKey);this.state.showSettings=false;alert('‚òÅÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Supabase ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');this.render();});
        // User management
        const cum=document.querySelector('.close-user-mgmt');if(cum)cum.addEventListener('click',()=>{this.state.showUserMgmt=false;this.state.showAddUser=false;this.render();});
        const aub=document.querySelector('.add-user-btn');if(aub)aub.addEventListener('click',()=>{this.state.showAddUser=true;this.render();});
        const cau=document.querySelector('.cancel-add-user');if(cau)cau.addEventListener('click',()=>{this.state.showAddUser=false;this.render();});
        const cfu=document.querySelector('.confirm-add-user');if(cfu)cfu.addEventListener('click',()=>{
            const un=document.getElementById('new-username')?.value?.trim();const pw=document.getElementById('new-password')?.value?.trim();const nm=document.getElementById('new-name')?.value?.trim();const rl=document.getElementById('new-role')?.value;
            if(!un||!pw||!nm){alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');return;}
            if(this.auth.users.find(u=>u.username===un)){alert('‚ö†Ô∏è ‡∏°‡∏µ Username ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß');return;}
            this.auth.addUser({username:un,password:pw,name:nm,role:rl,active:true});this.state.showAddUser=false;this.render();
        });
        document.querySelectorAll('.delete-user-btn').forEach(el=>el.addEventListener('click',e=>{const uid=parseInt(e.currentTarget.dataset.deleteUser);if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ?')){this.auth.deleteUser(uid);this.render();}}));
        // Image management
        const cim=document.querySelector('.close-image-mgmt');if(cim)cim.addEventListener('click',()=>{this.state.showImageMgmt=false;this.state.imageProduct=null;this.render();});
        const pib=document.querySelector('.pick-img-btn');if(pib)pib.addEventListener('click',()=>document.getElementById('img-file-input')?.click());
        const dz=document.getElementById('img-drop-zone');if(dz)dz.addEventListener('click',()=>document.getElementById('img-file-input')?.click());
        const fi=document.getElementById('img-file-input');if(fi)fi.addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;if(f.size>2*1024*1024){alert('‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2MB');return;}const r=new FileReader();r.onload=ev=>{this.setProductImage(this.state.imageProduct.id,ev.target.result);this.state.showImageMgmt=false;this.state.imageProduct=null;this.render();};r.readAsDataURL(f);});
        const rib=document.querySelector('.remove-img-btn');if(rib)rib.addEventListener('click',()=>{if(confirm('‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ?')){this.removeProductImage(this.state.imageProduct.id);this.state.showImageMgmt=false;this.state.imageProduct=null;this.render();}});
        // Reports
        document.querySelectorAll('[data-tab]').forEach(el=>el.addEventListener('click',e=>{this.state.reportTab=e.currentTarget.dataset.tab;this.render();}));
        const mf=document.getElementById('month-filter');if(mf)mf.addEventListener('change',e=>{this.state.selectedMonth=e.target.value;this.render();});
        // Dashboard
        document.querySelectorAll('[data-dash-sub]').forEach(el=>el.addEventListener('click',e=>{this.state.dashSubTab=e.currentTarget.dataset.dashSub;this.render();}));
        document.querySelectorAll('[data-dash-period]').forEach(el=>el.addEventListener('click',e=>{this.state.dashPeriod=e.currentTarget.dataset.dashPeriod;this.render();}));
        const dd=document.getElementById('dash-date');if(dd)dd.addEventListener('change',e=>{this.state.dashDate=e.target.value;this.render();});
        const dw=document.getElementById('dash-week');if(dw)dw.addEventListener('change',e=>{this.state.dashWeekOffset=parseInt(e.target.value);this.render();});
        const dm=document.getElementById('dash-month');if(dm)dm.addEventListener('change',e=>{this.state.dashMonthKey=e.target.value;this.render();});
        const dy=document.getElementById('dash-year');if(dy)dy.addEventListener('change',e=>{this.state.dashYear=e.target.value;this.render();});
        const dc=document.getElementById('dash-compare');if(dc)dc.addEventListener('change',e=>{this.state.dashCompare=e.target.checked;this.render();});
        document.querySelectorAll('.dash-nav').forEach(el=>el.addEventListener('click',e=>{const nav=e.currentTarget.dataset.dashNav;if(nav==='prev-day'){const d=new Date(this.state.dashDate);d.setDate(d.getDate()-1);this.state.dashDate=d.toISOString().split('T')[0];}if(nav==='next-day'){const d=new Date(this.state.dashDate);d.setDate(d.getDate()+1);this.state.dashDate=d.toISOString().split('T')[0];}if(nav==='today')this.state.dashDate=new Date().toISOString().split('T')[0];this.render();}));
        document.querySelectorAll('[data-dtop-cat]').forEach(el=>el.addEventListener('click',e=>{this.state.dashTopCat=e.currentTarget.dataset.dtopCat;this.render();}));
        document.querySelectorAll('[data-line-mode]').forEach(el=>el.addEventListener('click',e=>{this._pbiLineMode=e.currentTarget.dataset.lineMode;e.currentTarget.parentElement.querySelectorAll('.pbi-abtn').forEach(b=>b.classList.remove('active'));e.currentTarget.classList.add('active');this.initDashboardCharts();}));
        document.querySelectorAll('[data-donut-mode]').forEach(el=>el.addEventListener('click',e=>{this._pbiDonutMode=e.currentTarget.dataset.donutMode;e.currentTarget.parentElement.querySelectorAll('.pbi-abtn').forEach(b=>b.classList.remove('active'));e.currentTarget.classList.add('active');this.initDashboardCharts();}));
        // Export
        document.querySelectorAll('[data-export-period]').forEach(el=>el.addEventListener('click',e=>{this.state.exportPeriod=e.currentTarget.dataset.exportPeriod;this.render();}));
        const ed=document.getElementById('export-date');if(ed)ed.addEventListener('change',e=>{this.state.exportDate=e.target.value;this.render();});
        const ew=document.getElementById('export-week');if(ew)ew.addEventListener('change',e=>{this.state.exportWeek=e.target.value;this.render();});
        const em=document.getElementById('export-month');if(em)em.addEventListener('change',e=>{this.state.exportMonth=e.target.value;this.render();});
        const ey=document.getElementById('export-year');if(ey)ey.addEventListener('change',e=>{this.state.exportYear=e.target.value;this.render();});
        document.querySelectorAll('.date-nav-btn').forEach(el=>el.addEventListener('click',e=>{const nav=e.currentTarget.dataset.dateNav;const d=new Date(this.state.exportDate+'T00:00:00');if(nav==='prev')d.setDate(d.getDate()-1);else if(nav==='next')d.setDate(d.getDate()+1);else d.setTime(new Date().getTime());this.state.exportDate=d.toISOString().split('T')[0];this.render();}));
        const epc=document.querySelector('.export-period-csv');if(epc)epc.addEventListener('click',()=>this.exportPeriodCSV());
        const eps=document.querySelector('.export-period-sheets');if(eps)eps.addEventListener('click',()=>this.exportPeriodSheets());
        // Demo modal
        document.querySelectorAll('.close-demo').forEach(b=>b.addEventListener('click',()=>{this.state.showDemoGenerator=false;this.render();}));
        document.querySelectorAll('[data-demo-months]').forEach(el=>el.addEventListener('click',e=>{this.state.demoMonths=parseInt(e.currentTarget.dataset.demoMonths);this.render();}));
        document.querySelectorAll('[data-demo-orders]').forEach(el=>el.addEventListener('click',e=>{this.state.demoOrdersPerDay=e.currentTarget.dataset.demoOrders;this.render();}));
        const dp=document.getElementById('demo-peak');if(dp)dp.addEventListener('change',e=>{this.state.demoPeakHour=e.target.checked;this.render();});
        const gb=document.querySelector('.generate-demo-btn');if(gb)gb.addEventListener('click',()=>this.generateDemoData());
    }
}

const app = new POSApp();
app.render();
</script>
</body>
</html>
